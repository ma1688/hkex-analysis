{% extends "base.html" %}

{% block title %}文件上传 - 港股公告分析管理系统{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-upload me-2"></i>文件上传</h2>
    </div>

    <!-- 上传表单 -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cloud-upload-alt me-2"></i>上传文档
                    </h5>
                </div>
                <div class="card-body">
                    <form id="upload-form">
                        <div class="mb-3">
                            <label class="form-label">目录路径 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="directory_path" name="directory_path"
                                   placeholder="/Users/ericp/hkex-analysis/HKEX" required>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                请输入包含PDF文件的目录路径，系统将自动扫描并上传所有PDF文件
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="recursive_scan" name="recursive_scan" checked>
                                <label class="form-check-label" for="recursive_scan">
                                    <strong>递归扫描子目录</strong>
                                    <i class="fas fa-question-circle text-muted" data-bs-toggle="tooltip"
                                       title="扫描所有子目录中的PDF文件"></i>
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto_filter" name="auto_filter" checked>
                                <label class="form-check-label" for="auto_filter">
                                    <strong>启用自动文档过滤</strong>
                                    <i class="fas fa-question-circle text-muted" data-bs-toggle="tooltip"
                                       title="系统会自动过滤掉月报表、年报等非目标文档，并从文件名自动解析股票代码和文档类型"></i>
                                </label>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary btn-lg" id="scan-btn">
                                <i class="fas fa-search me-1"></i>扫描目录
                            </button>
                            <button type="submit" class="btn btn-success btn-lg" id="upload-btn" style="display: none;">
                                <i class="fas fa-upload me-1"></i>开始上传 (<span id="file-count">0</span> 个文件)
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="reset-btn">
                                <i class="fas fa-redo me-1"></i>重置
                            </button>
                        </div>
                    </form>

                    <div id="scan-results" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>扫描结果
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="file-list">
                                    <div class="text-center py-3">
                                        <div class="spinner-border"></div>
                                        <p class="mt-2 text-muted">正在扫描目录...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 侧边栏说明 -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>使用说明
                    </h6>
                </div>
                <div class="card-body">
                    <ol class="small">
                        <li>输入包含PDF文件的目录路径</li>
                        <li>可选择递归扫描子目录</li>
                        <li>建议启用自动过滤功能</li>
                        <li>点击"扫描目录"查看找到的文件</li>
                        <li>确认后点击"开始上传"</li>
                        <li>系统将自动解析股票代码和文档类型</li>
                    </ol>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>注意事项
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="small mb-0">
                        <li>仅支持PDF格式文件</li>
                        <li>文件名应包含股票代码（如：00328）</li>
                        <li>文件名建议包含文档类型关键词</li>
                        <li>自动过滤会跳过月报表、年报等</li>
                        <li>系统会从路径和文件名自动解析信息</li>
                        <li>处理完成后可在任务页面查看进度</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传历史 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>最近上传
                    </h5>
                    <button class="btn btn-sm btn-light" onclick="loadUploadHistory()">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                </div>
                <div class="card-body">
                    <div id="upload-history">
                        <p class="text-muted text-center">暂无上传记录</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let scannedFiles = [];
    let uploadedFiles = [];

    // 扫描目录
    document.getElementById('scan-btn').addEventListener('click', async () => {
        const directoryPath = document.getElementById('directory_path').value.trim();
        const recursiveScan = document.getElementById('recursive_scan').checked;
        const autoFilter = document.getElementById('auto_filter').checked;

        if (!directoryPath) {
            showAlert('请输入目录路径', 'warning');
            return;
        }

        const scanBtn = document.getElementById('scan-btn');
        const originalText = scanBtn.innerHTML;
        scanBtn.disabled = true;
        scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>扫描中...';

        try {
            const response = await fetch('/upload/scan-directory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    directory_path: directoryPath,
                    recursive: recursiveScan,
                    auto_filter: autoFilter
                })
            });

            const result = await response.json();

            if (response.ok) {
                scannedFiles = result.files;
                displayScannedFiles(result.files, result.skipped);
                document.getElementById('scan-results').style.display = 'block';
                document.getElementById('upload-btn').style.display = 'block';
                document.getElementById('file-count').textContent = scannedFiles.length;

                showAlert(`扫描完成！找到 ${scannedFiles.length} 个PDF文件`, 'success');
            } else {
                throw new Error(result.detail || '扫描失败');
            }

        } catch (error) {
            console.error('扫描错误:', error);
            showAlert('扫描失败: ' + error.message, 'danger');
        } finally {
            scanBtn.disabled = false;
            scanBtn.innerHTML = originalText;
        }
    });

    // 显示扫描结果
    function displayScannedFiles(files, skipped = []) {
        const fileListDiv = document.getElementById('file-list');

        let html = '';

        if (files.length === 0) {
            html = `
                <div class="text-center py-4">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <p class="text-muted">未找到PDF文件</p>
                </div>
            `;
        } else {
            html = `
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    找到 <strong>${files.length}</strong> 个PDF文件
                    ${skipped.length > 0 ? `，跳过 <strong>${skipped.length}</strong> 个不符合条件的文件` : ''}
                </div>

                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>股票代码</th>
                                <th>文档类型</th>
                                <th>路径</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${files.map(file => `
                                <tr>
                                    <td>
                                        <i class="fas fa-file-pdf text-danger me-1"></i>
                                        ${file.name}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">${file.stock_code || '未知'}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">${file.document_type || '未知'}</span>
                                    </td>
                                    <td class="small text-muted">${file.path}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            if (skipped.length > 0) {
                html += `
                    <div class="mt-3">
                        <h6 class="text-muted">跳过的文件：</h6>
                        <ul class="list-group list-group-flush">
                            ${skipped.slice(0, 5).map(item => `
                                <li class="list-group-item list-group-item-warning py-2">
                                    <small>${item.file}</small>
                                    <br>
                                    <small class="text-muted">原因: ${item.reason}</small>
                                </li>
                            `).join('')}
                            ${skipped.length > 5 ? `<li class="list-group-item"><small class="text-muted">还有 ${skipped.length - 5} 个文件...</small></li>` : ''}
                        </ul>
                    </div>
                `;
            }
        }

        fileListDiv.innerHTML = html;
    }

    // 表单提交
    document.getElementById('upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (scannedFiles.length === 0) {
            showAlert('请先扫描目录', 'warning');
            return;
        }

        const uploadBtn = document.getElementById('upload-btn');
        const originalText = uploadBtn.innerHTML;
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>上传中...';

        try {
            const response = await fetch('/upload/batch-from-directory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    files: scannedFiles,
                    auto_filter: document.getElementById('auto_filter').checked
                })
            });

            const result = await response.json();

            if (response.ok) {
                showAlert(`上传成功！创建了 ${result.task_ids.length} 个任务`, 'success');

                // 重置表单
                document.getElementById('upload-form').reset();
                scannedFiles = [];
                uploadedFiles = [];
                document.getElementById('scan-results').style.display = 'none';
                document.getElementById('upload-btn').style.display = 'none';

                // 刷新上传历史
                loadUploadHistory();
            } else {
                throw new Error(result.detail || '上传失败');
            }

        } catch (error) {
            console.error('上传错误:', error);
            showAlert('上传失败: ' + error.message, 'danger');
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalText;
        }
    });

    // 重置按钮
    document.getElementById('reset-btn').addEventListener('click', () => {
        document.getElementById('upload-form').reset();
        scannedFiles = [];
        uploadedFiles = [];
        document.getElementById('scan-results').style.display = 'none';
        document.getElementById('upload-btn').style.display = 'none';
    });

    // 加载上传历史
    async function loadUploadHistory() {
        try {
            const response = await fetch('/tasks/?limit=10');
            const tasks = await response.json();

            const historyDiv = document.getElementById('upload-history');
            if (tasks.length === 0) {
                historyDiv.innerHTML = '<p class="text-muted text-center">暂无上传记录</p>';
                return;
            }

            historyDiv.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>股票代码</th>
                                <th>文档类型</th>
                                <th>状态</th>
                                <th>进度</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tasks.map(task => `
                                <tr>
                                    <td>${task.stock_code}</td>
                                    <td>${task.document_type}</td>
                                    <td>${getStatusBadge(task.status)}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar" style="width: ${task.progress}%">
                                                ${task.progress}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>${new Date(task.created_at).toLocaleString()}</td>
                                    <td>
                                        <a href="/tasks" class="btn btn-sm btn-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

        } catch (error) {
            console.error('加载上传历史失败:', error);
        }
    }

    // 获取状态徽章
    function getStatusBadge(status) {
        const badges = {
            'pending': '<span class="badge bg-warning">等待中</span>',
            'processing': '<span class="badge bg-info">处理中</span>',
            'completed': '<span class="badge bg-success">已完成</span>',
            'failed': '<span class="badge bg-danger">失败</span>',
            'cancelled': '<span class="badge bg-secondary">已取消</span>'
        };
        return badges[status] || '';
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', () => {
        loadUploadHistory();

        // 初始化工具提示
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}
