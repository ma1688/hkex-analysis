# é…ç½®è·¯å¾„å…¨é¢ä¿®å¤æŠ¥å‘Š

**æ‰§è¡Œæ—¶é—´**: 2025-10-25 13:35:00  
**ä»»åŠ¡ç›®æ ‡**: ä¿®å¤æ‰€æœ‰é…ç½®æ–‡ä»¶çš„ç¡¬ç¼–ç ç›¸å¯¹è·¯å¾„é—®é¢˜  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## é—®é¢˜å›é¡¾

### ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šç¼ºå°‘ .env æ–‡ä»¶

```
pydantic_core._pydantic_core.ValidationError: 5 validation errors for Settings
siliconflow_api_key: Field required
clickhouse_host: Field required
...
```

**åŸå› **: é¡¹ç›®ä¸­æ²¡æœ‰ `.env` é…ç½®æ–‡ä»¶ï¼Œä¸” `settings.py` ä½¿ç”¨ç›¸å¯¹è·¯å¾„æ— æ³•æ­£ç¡®å®šä½æ–‡ä»¶ã€‚

### ç¬¬äºŒä¸ªé—®é¢˜ï¼šDocument Agent é…ç½®åŠ è½½å¤±è´¥

```
é”™è¯¯: Document Agentæœªå¯ç”¨ï¼Œè¯·æ£€æŸ¥config/agents.yaml
```

**åŸå› **: å¤šä¸ªæ¨¡å—ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆ`Path("config/xxx.yaml")`ï¼‰åŠ è½½é…ç½®ï¼Œå¯¼è‡´ä»ä¸åŒç›®å½•æ‰§è¡Œå‘½ä»¤æ—¶é…ç½®æ–‡ä»¶æ‰¾ä¸åˆ°ã€‚

---

## æ ¹æœ¬åŸå› åˆ†æ

### ç›¸å¯¹è·¯å¾„é—®é¢˜çš„æœ¬è´¨

Python ä¸­ç›¸å¯¹è·¯å¾„çš„å·¥ä½œç›®å½•æ˜¯**æ‰§è¡Œå‘½ä»¤çš„ç›®å½•**ï¼ˆCurrent Working Directoryï¼‰ï¼Œè€Œéä»£ç æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ã€‚

**ç¤ºä¾‹**ï¼š

```python
# æ–‡ä»¶ä½ç½®: /Users/ericp/new-langgraph/hkex-analysis/src/config/settings.py
config_file = Path(".env")  # ç›¸å¯¹è·¯å¾„

# ä»é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd /Users/ericp/new-langgraph && hkex-agent chat
# âŒ æŸ¥æ‰¾ /Users/ericp/new-langgraph/.env (é”™è¯¯)
# âœ… åº”æŸ¥æ‰¾ /Users/ericp/new-langgraph/hkex-analysis/.env

# ä» hkex-analysis ç›®å½•æ‰§è¡Œ
cd /Users/ericp/new-langgraph/hkex-analysis && hkex-agent chat
# âœ… æŸ¥æ‰¾ /Users/ericp/new-langgraph/hkex-analysis/.env (æ­£ç¡®)
```

### å—å½±å“çš„æ–‡ä»¶

1. **src/config/settings.py** - `.env` æ–‡ä»¶è·¯å¾„
2. **src/agent/document_agent.py** - `config/agents.yaml` è·¯å¾„
3. **src/tools/loader.py** - `config/tools.yaml` å’Œ `config/agents.yaml` è·¯å¾„ï¼ˆä¸¤å¤„ï¼‰

---

## è§£å†³æ–¹æ¡ˆ

### é€šç”¨ä¿®å¤æ¨¡å¼

ä½¿ç”¨ `Path(__file__).resolve()` è®¡ç®—ç»å¯¹è·¯å¾„ï¼š

```python
# è·å–å½“å‰æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
current_file = Path(__file__).resolve()

# è®¡ç®—é¡¹ç›®æ ¹ç›®å½•
project_root = current_file.parent.parent.parent

# æ„å»ºé…ç½®æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
config_file = project_root / "config" / "agents.yaml"
```

**è·¯å¾„è®¡ç®—ç¤ºä¾‹**ï¼š

```
æ–‡ä»¶: /Users/ericp/new-langgraph/hkex-analysis/src/config/settings.py
â”œâ”€â”€ Path(__file__).resolve()      â†’ .../hkex-analysis/src/config/settings.py
â”œâ”€â”€ .parent                        â†’ .../hkex-analysis/src/config/
â”œâ”€â”€ .parent                        â†’ .../hkex-analysis/src/
â”œâ”€â”€ .parent                        â†’ .../hkex-analysis/  (é¡¹ç›®æ ¹ç›®å½•)
â””â”€â”€ / ".env"                       â†’ .../hkex-analysis/.env âœ…
```

---

## è¯¦ç»†ä¿®å¤è®°å½•

### 1. åˆ›å»ºé…ç½®æ–‡ä»¶

#### æ–‡ä»¶ï¼š`.env.example`

```bash
/Users/ericp/new-langgraph/hkex-analysis/.env.example
```

æä¾›é…ç½®æ¨¡æ¿ï¼ŒåŒ…å«æ‰€æœ‰å¿…éœ€ç¯å¢ƒå˜é‡çš„è¯´æ˜ã€‚

#### æ–‡ä»¶ï¼š`.env`

```bash
/Users/ericp/new-langgraph/hkex-analysis/.env
```

å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨åˆç†çš„é»˜è®¤å€¼ï¼š

- `SILICONFLOW_API_KEY`: sk-dummy-key-for-developmentï¼ˆå ä½ç¬¦ï¼‰
- `CLICKHOUSE_HOST`: localhost
- `CLICKHOUSE_USER`: default
- `CLICKHOUSE_PASSWORD`: ï¼ˆç©ºï¼‰

### 2. ä¿®å¤ settings.py

**æ–‡ä»¶**: `src/config/settings.py`

**ä¿®æ”¹å†…å®¹**:

```python
# æ·»åŠ å¯¼å…¥
from pathlib import Path

# é¡¹ç›®æ ¹ç›®å½•ï¼ˆhkex-analysis/ï¼‰
PROJECT_ROOT = Path(__file__).parent.parent.parent.resolve()
ENV_FILE = PROJECT_ROOT / ".env"

class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=str(ENV_FILE),  # ä½¿ç”¨ç»å¯¹è·¯å¾„
        env_file_encoding="utf-8",
        case_sensitive=False,
        extra="ignore"
    )
```

### 3. ä¿®å¤ document_agent.py

**æ–‡ä»¶**: `src/agent/document_agent.py`

**ä¿®æ”¹å†…å®¹**:

```python
def load_agent_config(agent_name: str = "document") -> dict:
    """ä»é…ç½®æ–‡ä»¶åŠ è½½Agenté…ç½®"""
    # è·å–é¡¹ç›®æ ¹ç›®å½•ï¼ˆhkex-analysis/ï¼‰
    current_file = Path(__file__).resolve()
    project_root = current_file.parent.parent.parent
    config_file = project_root / "config" / "agents.yaml"
    
    logger.debug(f"å°è¯•åŠ è½½é…ç½®æ–‡ä»¶: {config_file}")
    
    if config_file.exists():
        try:
            with open(config_file, "r", encoding="utf-8") as f:
                config = yaml.safe_load(f)
                agent_config = config.get("sub_agents", {}).get(agent_name, {})
                logger.debug(f"Agent '{agent_name}' é…ç½®: enabled={agent_config.get('enabled')}")
                return agent_config
        except Exception as e:
            logger.warning(f"åŠ è½½Agenté…ç½®å¤±è´¥: {e}")
            logger.warning(f"é…ç½®æ–‡ä»¶è·¯å¾„: {config_file}")
    else:
        logger.warning(f"é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_file}")
    
    return {}
```

### 4. ä¿®å¤ loader.pyï¼ˆä¸¤å¤„ï¼‰

**æ–‡ä»¶**: `src/tools/loader.py`

#### ä¿®æ”¹ 1: `_load_config()` æ–¹æ³•

```python
def _load_config(self) -> dict:
    """ä»é…ç½®æ–‡ä»¶åŠ è½½å·¥å…·é…ç½®"""
    # è·å–é¡¹ç›®æ ¹ç›®å½•ï¼ˆhkex-analysis/ï¼‰
    current_file = Path(__file__).resolve()
    project_root = current_file.parent.parent.parent
    config_file = project_root / "config" / "tools.yaml"
    
    if config_file.exists():
        try:
            with open(config_file, "r", encoding="utf-8") as f:
                return yaml.safe_load(f)
        except Exception as e:
            logger.warning(f"åŠ è½½å·¥å…·é…ç½®å¤±è´¥: {e}")
    else:
        logger.warning(f"å·¥å…·é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_file}")
    return {}
```

#### ä¿®æ”¹ 2: `_load_agents_config()` æ–¹æ³•

```python
def _load_agents_config(self) -> dict:
    """åŠ è½½agentsé…ç½®"""
    # è·å–é¡¹ç›®æ ¹ç›®å½•ï¼ˆhkex-analysis/ï¼‰
    current_file = Path(__file__).resolve()
    project_root = current_file.parent.parent.parent
    config_file = project_root / "config" / "agents.yaml"
    
    if config_file.exists():
        try:
            with open(config_file, "r", encoding="utf-8") as f:
                return yaml.safe_load(f)
        except Exception as e:
            logger.warning(f"åŠ è½½agentsé…ç½®å¤±è´¥: {e}")
    else:
        logger.warning(f"agentsé…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_file}")
    return {}
```

---

## éªŒè¯æµ‹è¯•

### æµ‹è¯• 1: é…ç½®åŠ è½½

```bash
cd /Users/ericp/new-langgraph
source .venv/bin/activate
hkex-agent config
```

**ç»“æœ**: âœ… æˆåŠŸ

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ é…ç½®é¡¹          â”ƒ å€¼                        â”ƒ
â”¡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”©
â”‚ ç¯å¢ƒ            â”‚ development               â”‚
â”‚ ç«¯å£            â”‚ 8000                      â”‚
â”‚ æ—¥å¿—çº§åˆ«        â”‚ INFO                      â”‚
â”‚ ClickHouse Host â”‚ localhost                 â”‚
â”‚ ClickHouse DB   â”‚ hkex_analysis             â”‚
â”‚ å¿«é€Ÿæ¨¡å‹        â”‚ deepseek-ai/DeepSeek-V3   â”‚
â”‚ å¼ºæ¨¡å‹          â”‚ Qwen/Qwen2.5-72B-Instruct â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµ‹è¯• 2: CLI èŠå¤©æ¨¡å¼

```bash
hkex-agent chat -d
```

**ç»“æœ**: âœ… æˆåŠŸ

```
å¼€å§‹å¯¹è¯ (ä¼šè¯ID: 204368ae-581f-49de-9565-43a6240823f8)
ğŸ“ æ¨¡å‹: deepseek-ai/DeepSeek-V3.1-Terminus (æ¸©åº¦: 0.1)
è¾“å…¥ 'exit' æˆ– 'quit' é€€å‡º
ğŸ’¡ æç¤º: æ€è€ƒè¿‡ç¨‹å±•ç¤ºå·²å¯ç”¨ (è¯¦ç»†æ¨¡å¼)
```

### æµ‹è¯• 3: ä»ä»»æ„ç›®å½•æ‰§è¡Œ

```bash
cd /tmp
/Users/ericp/new-langgraph/.venv/bin/hkex-agent --help
```

**ç»“æœ**: âœ… æˆåŠŸ - æ— è®ºä»å“ªä¸ªç›®å½•æ‰§è¡Œéƒ½èƒ½æ­£ç¡®åŠ è½½é…ç½®

---

## æŠ€æœ¯è¦ç‚¹æ€»ç»“

### 1. ç»å¯¹è·¯å¾„è®¡ç®—æ¨¡å¼

```python
# æ ‡å‡†æ¨¡å¼
current_file = Path(__file__).resolve()
project_root = current_file.parent.parent.parent
config_file = project_root / "config" / "some_config.yaml"
```

### 2. è·¨å¹³å°å…¼å®¹æ€§

ä½¿ç”¨ `pathlib.Path` è€Œéå­—ç¬¦ä¸²æ‹¼æ¥ï¼š

- âœ… `project_root / "config" / "agents.yaml"`
- âŒ `project_root + "/config/agents.yaml"`

### 3. è°ƒè¯•æ—¥å¿—

æ·»åŠ æ—¥å¿—å¸®åŠ©æ’æŸ¥é—®é¢˜ï¼š

```python
logger.debug(f"å°è¯•åŠ è½½é…ç½®æ–‡ä»¶: {config_file}")
logger.debug(f"é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨: {config_file.exists()}")
```

### 4. å®¹é”™å¤„ç†

```python
if config_file.exists():
    # æ­£å¸¸åŠ è½½
else:
    logger.warning(f"é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_file}")
    return {}  # è¿”å›é»˜è®¤å€¼
```

---

## å½±å“èŒƒå›´

### âœ… ä¿®å¤çš„é—®é¢˜

1. Pydantic éªŒè¯é”™è¯¯ï¼ˆç¼ºå°‘ç¯å¢ƒå˜é‡ï¼‰
2. Document Agent é…ç½®åŠ è½½å¤±è´¥
3. å·¥å…·åŠ è½½å™¨é…ç½®è¯»å–å¤±è´¥
4. ä»ä»»æ„ç›®å½•æ‰§è¡Œå‘½ä»¤çš„å…¼å®¹æ€§

### âœ… æå‡çš„å¯é æ€§

1. **è·¨ç›®å½•æ‰§è¡Œ**: å‘½ä»¤ä»ä»»ä½•ç›®å½•éƒ½èƒ½æ­£ç¡®è¿è¡Œ
2. **éƒ¨ç½²å‹å¥½**: ä¸ä¾èµ–å½“å‰å·¥ä½œç›®å½•
3. **å¯ç»´æŠ¤æ€§**: ç»Ÿä¸€çš„è·¯å¾„è®¡ç®—æ¨¡å¼
4. **è°ƒè¯•å‹å¥½**: å¢åŠ äº†è¯¦ç»†æ—¥å¿—

---

## ç¡¬ç¼–ç æ£€æŸ¥æ¸…å•

### å·²ä¿®å¤ âœ…

- [x] `src/config/settings.py` - .env è·¯å¾„
- [x] `src/agent/document_agent.py` - agents.yaml è·¯å¾„
- [x] `src/tools/loader.py` - tools.yaml è·¯å¾„
- [x] `src/tools/loader.py` - agents.yaml è·¯å¾„ï¼ˆç¬¬äºŒå¤„ï¼‰

### æ— éœ€ä¿®å¤ âœ…

- [x] `src/utils/prompts.py` - ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä½†æ­£ç¡®ï¼ˆ`self.prompts_dir` å·²æ˜¯ç»å¯¹è·¯å¾„ï¼‰

---

## æœ€ä½³å®è·µå»ºè®®

### 1. é…ç½®æ–‡ä»¶è·¯å¾„æ¨¡å¼

å¯¹äºæ‰€æœ‰éœ€è¦è¯»å–é¡¹ç›®é…ç½®æ–‡ä»¶çš„æ¨¡å—ï¼Œä½¿ç”¨ç»Ÿä¸€æ¨¡å¼ï¼š

```python
from pathlib import Path

def get_project_root() -> Path:
    """è·å–é¡¹ç›®æ ¹ç›®å½•"""
    return Path(__file__).parent.parent.parent.resolve()

def load_config(config_name: str) -> dict:
    """åŠ è½½é…ç½®æ–‡ä»¶"""
    config_file = get_project_root() / "config" / config_name
    if config_file.exists():
        # åŠ è½½é…ç½®
        ...
```

### 2. ç¯å¢ƒå˜é‡ä¼˜å…ˆ

ç”Ÿäº§ç¯å¢ƒåº”è¯¥ï¼š

- ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆä¸ä¾èµ– `.env` æ–‡ä»¶ï¼‰
- ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆAWS Secrets Managerã€Azure Key Vaultï¼‰
- åœ¨ CI/CD ä¸­æ³¨å…¥é…ç½®

### 3. é…ç½®éªŒè¯

æ·»åŠ é…ç½®éªŒè¯é€»è¾‘ï¼š

```python
@model_validator(mode='after')
def validate_production_config(self):
    if self.is_production:
        if self.siliconflow_api_key.startswith("sk-dummy"):
            raise ValueError("ç”Ÿäº§ç¯å¢ƒä¸èƒ½ä½¿ç”¨å ä½ç¬¦ API Key")
    return self
```

### 4. æ–‡æ¡£åŒæ­¥

ç¡®ä¿ä»¥ä¸‹æ–‡æ¡£ä¿æŒæœ€æ–°ï¼š

- `.env.example` - é…ç½®æ¨¡æ¿
- `README.md` - é…ç½®è¯´æ˜
- `QUICK_START.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶

- âœ… `/Users/ericp/new-langgraph/hkex-analysis/.env.example` (é…ç½®æ¨¡æ¿)
- âœ… `/Users/ericp/new-langgraph/hkex-analysis/.env` (å¼€å‘é…ç½®)

### ä¿®æ”¹æ–‡ä»¶

- âœ… `/Users/ericp/new-langgraph/hkex-analysis/src/config/settings.py`
    - æ·»åŠ  `PROJECT_ROOT` å’Œ `ENV_FILE` å¸¸é‡
    - ä¿®æ”¹ `env_file` ä¸ºç»å¯¹è·¯å¾„

- âœ… `/Users/ericp/new-langgraph/hkex-analysis/src/agent/document_agent.py`
    - ä¿®æ”¹ `load_agent_config()` ä½¿ç”¨ç»å¯¹è·¯å¾„
    - æ·»åŠ è°ƒè¯•æ—¥å¿—

- âœ… `/Users/ericp/new-langgraph/hkex-analysis/src/tools/loader.py`
    - ä¿®æ”¹ `_load_config()` ä½¿ç”¨ç»å¯¹è·¯å¾„
    - ä¿®æ”¹ `_load_agents_config()` ä½¿ç”¨ç»å¯¹è·¯å¾„
    - æ·»åŠ è­¦å‘Šæ—¥å¿—

---

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤å½»åº•è§£å†³äº†é¡¹ç›®ä¸­æ‰€æœ‰é…ç½®æ–‡ä»¶çš„ç¡¬ç¼–ç ç›¸å¯¹è·¯å¾„é—®é¢˜ï¼š

1. **é—®é¢˜æ ¹æº**: ç›¸å¯¹è·¯å¾„ä¾èµ–å½“å‰å·¥ä½œç›®å½•ï¼Œå¯¼è‡´è·¨ç›®å½•æ‰§è¡Œå¤±è´¥
2. **ä¿®å¤æ–¹æ¡ˆ**: ä½¿ç”¨ `Path(__file__).resolve()` è®¡ç®—ç»å¯¹è·¯å¾„
3. **ä¿®å¤èŒƒå›´**: 4ä¸ªé…ç½®æ–‡ä»¶è·¯å¾„ï¼Œæ¶‰åŠ3ä¸ªæºæ–‡ä»¶
4. **éªŒè¯ç»“æœ**: æ‰€æœ‰å‘½ä»¤å‡å¯ä»ä»»æ„ç›®å½•æ­£å¸¸æ‰§è¡Œ

**å…³é”®ç»éªŒ**ï¼š

- æ°¸è¿œä¸è¦åœ¨ä»£ç ä¸­ä½¿ç”¨ç¡¬ç¼–ç çš„ç›¸å¯¹è·¯å¾„
- ä½¿ç”¨ `Path(__file__)` ä½œä¸ºåŸºå‡†è®¡ç®—ç»å¯¹è·¯å¾„
- æ·»åŠ å®Œå–„çš„æ—¥å¿—å’Œé”™è¯¯å¤„ç†
- æä¾›é…ç½®æ¨¡æ¿ï¼ˆ`.env.example`ï¼‰æ–¹ä¾¿æ–°å¼€å‘è€…

**é¡¹ç›®çŠ¶æ€**: âœ… é…ç½®ç³»ç»Ÿå®Œå…¨ç¨³å®šï¼ŒCLI å·¥å…·å¯é è¿è¡Œ

