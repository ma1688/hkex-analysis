# Agent工具调用优化方案

**生成时间**: 2025-10-25  
**分析范围**: Supervisor、Planner、Document Agent、工具系统  
**分析深度**: 系统性架构分析 + 专家验证  

---

## 📊 问题诊断总结

### 核心问题识别（8大根本原因）

#### 1. **信息过载问题**
- **现象**: Document Agent配置了19个工具，超出LLM有效工作记忆
- **影响**: Agent需要在每次决策时扫描所有工具，导致选择犹豫和错误
- **证据**: `config/agents.yaml` 显示document agent有19个工具配置

#### 2. **缺少决策框架**
- **现象**: ReAct模式要求LLM自由发挥，但没有结构化指导
- **影响**: Agent缺少"什么情况下用什么工具"的明确规则
- **证据**: `src/utils/prompts.py` 中DOCUMENT_AGENT_SYSTEM_PROMPT只罗列工具

#### 3. **Prompt-Tool不匹配**
- **现象**: Prompt说"优先使用结构化数据"，但没有给出判断标准
- **影响**: Agent不知道何时应该用结构化工具vs文档检索工具
- **证据**: Prompt缺少Few-shot示例和决策树

#### 4. **Planner-Executor脱节**
- **现象**: Planner生成的plan只有task文本，没有工具推荐
- **影响**: Document Agent收到task后需要重新理解并选择工具
- **证据**: `src/agent/schemas.py` PlanStep没有recommended_tools字段

#### 5. **工具描述不精准**
- **现象**: 工具docstring缺少适用场景、前置条件、参数规范
- **影响**: LLM无法准确判断工具适用性和参数要求
- **证据**: `src/tools/structured_data.py` 工具描述只有基本参数说明

#### 6. **工具粒度不一致**
- **现象**: query_placing_data很具体，extract_key_info却支持5种模式
- **影响**: Agent难以建立统一的工具选择策略
- **证据**: `src/tools/synthesis.py` extract_key_info实际是5个工具的集合

#### 7. **缺少组合模式指导**
- **现象**: 没有明确的工具调用顺序说明
- **影响**: Agent不知道应该先search_documents→retrieve_chunks→synthesize
- **证据**: Prompt中没有工具链示例

#### 8. **无验证纠错机制**
- **现象**: 工具调用前无参数验证，失败后无fallback
- **影响**: 错误参数导致工具调用失败，浪费迭代次数
- **证据**: Document Agent和Reflector都没有工具选择验证逻辑

---

## 🎯 优化方案设计（6个维度）

### P0：立即实施（预期2-3人天，准确率+15-20%）

#### 方案1：Prompt重构 - 添加决策树和Few-Shot

**目标文件**: `src/utils/prompts.py`

**优化后的DOCUMENT_AGENT_SYSTEM_PROMPT结构**:

```python
DOCUMENT_AGENT_SYSTEM_PROMPT = """你是港股公告文档分析专家，负责检索和分析上市公司公告。

## 🎯 核心能力
1. 检索公告文档和切块内容
2. 查询结构化数据（IPO、配售、供股、合股）
3. 合成多个切块为连贯文本
4. 提取关键信息和数据

## 🔧 工具分层体系

### Layer 1: 基础检索层（优先使用）
- **search_documents**: 搜索公告元信息
  - 适用: 需要文档列表、不确定具体内容
  - 返回: doc_id, company_name, publish_date等
  
- **query_placing_data**: 查询配售结构化数据
  - 适用: 明确需要配售信息（价格、比例、承销商）
  - 前置: 必须有stock_code
  
- **query_ipo_data**: 查询IPO数据
- **query_rights_data**: 查询供股数据  
- **query_consolidation_data**: 查询合股数据

### Layer 2: 内容获取层
- **retrieve_chunks**: 获取公告详细内容
  - 适用: 已有doc_id，需要完整原文
  - 后续: 通常需要synthesize_chunks

### Layer 3: 分析处理层
- **synthesize_chunks**: 合成多个chunks为连贯文本
- **extract_key_info**: 提取结构化信息
- **compare_data**: 对比两组数据

## 🎯 工具选择决策树

```
用户查询 → 识别查询类型
    ↓
    ├─ 包含"配售/IPO/供股/合股"关键词？
    │   YES → 使用query_*_data（结构化查询）
    │   NO → 继续判断
    ↓
    ├─ 需要完整公告内容？
    │   YES → search_documents → retrieve_chunks → synthesize_chunks
    │   NO → 继续判断
    ↓
    ├─ 需要对比分析？
    │   YES → 分别检索 → compare_data
    │   NO → 使用search_documents
```

## 📝 工具调用示例（Few-Shot）

### 示例1: 查询配售信息
```
用户: 查询腾讯控股最近的配售公告
思考: 明确提到"配售"，应该用结构化数据工具
行动: query_placing_data
参数: {
  "stock_code": "00700.hk",
  "limit": 5
}
```

### 示例2: 需要详细内容
```
用户: 阿里巴巴最新公告说了什么？
思考: 需要完整内容，不是结构化数据查询
行动1: search_documents(stock_code="09988.hk", limit=1)
观察: 获得doc_id
行动2: retrieve_chunks(doc_id="xxx")
行动3: synthesize_chunks(chunks_json=...)
```

### 示例3: 对比分析
```
用户: 对比腾讯和阿里的配售条款
思考: 需要对比，先分别获取数据
行动1: query_placing_data(stock_code="00700.hk")
行动2: query_placing_data(stock_code="09988.hk")  
行动3: compare_data(data1_json=..., data2_json=...)
```

## ⚠️ 参数规范
- **stock_code格式**: 5位数字+.hk (例: 00700.hk)
- **日期格式**: YYYY-MM-DD (例: 2024-01-15)
- **limit默认值**: search_documents=5, retrieve_chunks=20
- **必需参数**: 
  - query_*_data必须提供stock_code
  - retrieve_chunks必须提供doc_id或stock_code或keyword之一

## 🚫 常见错误避免
1. ❌ 直接用retrieve_chunks而不先search_documents获取doc_id
   ✅ 先search_documents → 再retrieve_chunks
   
2. ❌ 查询配售信息时用retrieve_chunks
   ✅ 优先用query_placing_data（更快更准确）
   
3. ❌ stock_code格式错误 (如"700"而非"00700.hk")
   ✅ 始终使用5位数+.hk格式

当前任务：{task}
"""
```

**实施步骤**:
1. 备份原prompts.py
2. 替换DOCUMENT_AGENT_SYSTEM_PROMPT
3. 增加PLANNER_FEW_SHOT_EXAMPLES中的工具推荐示例
4. 测试3-5个典型场景

---

#### 方案2：工具描述增强

**目标文件**: `src/tools/*.py` (所有工具文件)

**增强模板**:

```python
@tool
def query_placing_data(
        stock_code: str,
        start_date: str = None,
        end_date: str = None,
        limit: int = 10
) -> str:
    """查询配售公告数据
    
    【适用场景】
    - 用户明确询问"配售"相关信息
    - 需要配售价、新股比例、承销商等结构化字段
    - 快速获取配售数据，无需完整公告原文
    
    【不适用场景】  
    - 需要完整公告原文 → 使用 retrieve_chunks
    - 不确定是否为配售公告 → 先用 search_documents 确认
    - 需要供股/合股数据 → 使用对应的 query_rights_data / query_consolidation_data
    
    【前置条件】
    - 必须提供 stock_code（格式：5位数字+.hk，如 00700.hk）
    - 如需按时间筛选，使用 start_date/end_date（格式：YYYY-MM-DD）
    
    【返回格式】
    JSON数组，每个元素包含：
    - stock_code, company_name, announcement_date
    - placing_price（配售价）
    - new_share_ratio（配售比例）
    - placing_agent（承销商）
    - status（状态）
    
    【后续工具链】
    - 如需更多细节 → retrieve_chunks(keyword="配售详情")
    - 如需对比其他公司 → 再次调用本工具查询另一家公司
    - 如需提取关键信息 → extract_key_info(info_type="terms")
    
    【示例】
    query_placing_data(
        stock_code="00700.hk",
        start_date="2024-01-01",
        limit=5
    )
    
    Args:
        stock_code: 股票代码，格式如'00700.hk'（必需）
        start_date: 起始日期 YYYY-MM-DD（可选）
        end_date: 结束日期 YYYY-MM-DD（可选）
        limit: 返回数量，默认10，建议5-20
        
    Returns:
        JSON格式的配售数据列表
    """
```

**实施步骤**:
1. 为每个工具添加【适用场景】【不适用场景】【前置条件】【后续工具链】
2. 优先处理高频使用的8个核心工具
3. 保持描述简洁，避免超过30行

---

### P1：中期优化（Week 3-4）

#### 方案3：Planner增强 - 推荐工具

**目标文件**: `src/agent/schemas.py`, `src/agent/planner.py`

**修改PlanStep Schema**:

```python
class PlanStep(BaseModel):
    step: int
    task: str
    agent: str
    recommended_tools: List[str] = []  # 新增：推荐工具列表
    tool_params_template: Dict[str, Any] = {}  # 新增：参数模板
    depends_on: List[int] = []
```

**修改Planner Prompt**:

```python
PLANNER_SYSTEM_PROMPT = """你是一个任务规划专家，负责将用户查询分解为可执行的步骤。

...（原有内容）

## 输出格式要求
每个步骤必须包含：
1. step: 步骤编号
2. task: 任务描述
3. agent: 执行Agent（document/market/financial/news）
4. **recommended_tools**: 推荐使用的工具列表（新增）
5. **tool_params_template**: 工具参数模板（新增）
6. depends_on: 依赖的步骤

## 工具推荐策略
- 如任务涉及"配售" → recommended_tools: ["query_placing_data"]
- 如任务需要"完整内容" → recommended_tools: ["search_documents", "retrieve_chunks", "synthesize_chunks"]
- 如任务需要"对比" → recommended_tools: ["query_*_data", "compare_data"]

示例:
{
  "steps": [
    {
      "step": 1,
      "task": "检索腾讯控股的配售公告数据",
      "agent": "document",
      "recommended_tools": ["query_placing_data"],
      "tool_params_template": {
        "stock_code": "00700.hk",
        "limit": 5
      },
      "depends_on": []
    }
  ]
}
"""
```

**实施步骤**:
1. 修改schemas.py中的PlanStep
2. 更新planner.py的Prompt
3. 修改supervisor.py中的_execute_document_node，传递recommended_tools

---

#### 方案4：工具分层优化

**目标**: 在Prompt和配置中明确工具层次

**修改agents.yaml**:

```yaml
sub_agents:
  document:
    enabled: true
    name: "公告文档分析Agent"
    temperature: 0.1
    tools:
      # === Layer 1: 基础检索层 ===
      - search_documents
      - query_ipo_data
      - query_placing_data
      - query_rights_data
      - query_consolidation_data
      
      # === Layer 2: 内容获取层 ===
      - retrieve_chunks
      - get_document_metadata
      
      # === Layer 3: 分析处理层 ===
      - synthesize_chunks
      - extract_key_info
      - compare_data
      
      # === Layer 4: 时间感知（辅助）===
      - get_current_time
      - get_market_time
      - calculate_time_diff
      
      # === Layer 5: 数据增强（辅助）===
      - enhance_market_data
      - get_real_time_stock_info
```

---

### P2：长期优化（Month 2）

#### 方案5：ToolSelector验证层

**新增文件**: `src/agent/tool_selector.py`

```python
class ToolSelector:
    """工具选择验证器 - 在工具调用前验证参数和适用性"""
    
    def validate_tool_call(
        self,
        tool_name: str,
        params: dict,
        context: str
    ) -> tuple[bool, str, dict]:
        """
        验证工具调用是否合理
        
        Returns:
            (is_valid, feedback_message, suggested_params)
        """
        # 1. 参数格式验证
        if tool_name.startswith("query_") and "stock_code" in params:
            stock_code = params["stock_code"]
            if not self._validate_stock_code(stock_code):
                return False, f"stock_code格式错误：{stock_code}，应为5位数+.hk", {
                    "stock_code": self._fix_stock_code(stock_code)
                }
        
        # 2. 前置条件检查
        if tool_name == "retrieve_chunks":
            if not any(k in params for k in ["doc_id", "stock_code", "keyword"]):
                return False, "retrieve_chunks需要doc_id、stock_code或keyword之一", {}
        
        # 3. 工具组合推荐
        if tool_name == "retrieve_chunks" and "doc_id" not in params:
            return True, "建议先调用search_documents获取doc_id", {
                "suggested_prior_tool": "search_documents"
            }
        
        return True, "验证通过", {}
```

---

#### 方案6：Structured ReAct模式

**目标**: 为Document Agent添加4步骤结构化思考

**实施**: 修改document_agent.py的system_prompt

```python
system_prompt = f"""
{DOCUMENT_AGENT_SYSTEM_PROMPT}

## 🧠 执行流程（结构化ReAct）

### Step 1 - 任务分析
- 识别查询类型：信息检索 / 对比分析 / 数据提取
- 识别关键实体：股票代码 / 日期范围 / 文档类型
- 确定数据源：结构化（query_*_data）/ 非结构化（文档原文）

### Step 2 - 工具选择
- 根据任务分析，从工具决策树选择工具
- 检查工具前置条件（参数要求）
- 确定工具调用顺序（单一 / 组合）

### Step 3 - 参数准备  
- 从任务中提取参数（stock_code, date等）
- 验证参数格式（使用【参数规范】）
- 设置合理默认值

### Step 4 - 执行与验证
- 调用工具
- 检查结果完整性
- 必要时调用后续工具（工具链）

当前任务：{task}

请按照以上4步骤执行。
"""
```

---

## 📈 实施路线图

### Week 1-2（P0 - 立即实施）
- **Day 1-3**: Prompt重构
  - 重写DOCUMENT_AGENT_SYSTEM_PROMPT
  - 添加决策树和5个Few-shot示例
  - 更新PLANNER_FEW_SHOT_EXAMPLES
  
- **Day 4-5**: 工具描述增强
  - 为8个核心工具添加增强描述
  - 为剩余11个工具添加增强描述
  
- **Day 6-7**: 测试验证
  - 准备10个测试用例（覆盖典型场景）
  - 对比优化前后的准确率
  - 收集Agent思考日志分析

### Week 3-4（P1 - 中期优化）
- **Day 1-2**: Planner增强
  - 修改PlanStep schema
  - 更新Planner prompt
  - 测试plan生成质量
  
- **Day 3-4**: 工具分层
  - 更新agents.yaml配置
  - 修改Prompt中的工具说明
  
- **Day 5-7**: 集成测试
  - 端到端测试
  - 性能基准测试

### Month 2（P2 - 长期优化）
- **Week 1-2**: ToolSelector
  - 设计验证规则
  - 实现ToolSelector
  - 集成到Document Agent
  
- **Week 3-4**: Structured ReAct
  - 设计4步骤流程
  - 修改Agent prompt
  - A/B测试对比

---

## 🎯 成功指标

### 量化指标
| 指标 | 当前值 | P0目标 | P1目标 | P2目标 |
|------|--------|--------|--------|--------|
| 工具选择准确率 | ~60% | 75% | 85% | 90% |
| 平均Agent迭代次数 | 5次 | 4.5次 | 4次 | 3.5次 |
| 无效工具调用率 | ~30% | 20% | 10% | 5% |
| 参数格式错误率 | ~20% | 10% | 5% | 2% |
| 任务完成率 | ~70% | 80% | 90% | 95% |

### 质量指标
- ✅ Agent思考日志更有逻辑性
- ✅ 工具组合更合理（先基础检索，后分析处理）
- ✅ 减少"反复尝试"现象
- ✅ 用户等待时间减少

---

## ⚠️ 风险评估与缓解

### P0风险（低）
**风险**: Prompt变长可能影响响应速度  
**缓解**: 
- 分层次展示，核心决策树在前
- 删除冗余说明
- 实测响应时间，必要时精简

**风险**: Few-shot示例可能不够典型  
**缓解**:
- 收集真实用户查询，选择高频场景
- 每2周更新一次示例

### P1风险（中）
**风险**: Planner推荐的工具可能不准确  
**缓解**:
- 设置为"推荐"而非"强制"
- Agent保留自主选择权
- 日志记录推荐准确率

### P2风险（中-高）
**风险**: 新组件增加系统复杂度  
**缓解**:
- 充分验证P0-P1效果后再引入
- 使用Feature Flag控制开关
- 保留回滚能力

---

## 🚀 立即行动清单

### 第1优先级（本周完成）
1. [ ] 备份当前prompts.py
2. [ ] 重写DOCUMENT_AGENT_SYSTEM_PROMPT（使用方案1模板）
3. [ ] 为8个核心工具添加增强描述
4. [ ] 准备5个测试用例
5. [ ] 测试并收集日志

### 第2优先级（下周完成）  
6. [ ] 分析测试日志，微调Prompt
7. [ ] 完成剩余11个工具的描述增强
8. [ ] 扩展测试用例到10个
9. [ ] 对比优化前后指标

### 第3优先级（协调确认）
10. [ ] 确认P1方案实施时间
11. [ ] 评估是否需要精简工具数量
12. [ ] 收集历史日志分析典型错误模式

---

## 📚 参考文档

- `src/utils/prompts.py` - Prompt模板系统
- `src/agent/document_agent.py` - Document Agent实现
- `src/agent/planner.py` - 任务规划器
- `src/tools/loader.py` - 工具加载器
- `config/agents.yaml` - Agent配置

---

## 🔍 专家验证建议

根据外部专家审查，以下是额外建议：

1. **验证阶段**: 在P0实施前，建议收集5-10个真实失败案例作为基准测试
2. **日志监控**: 建议为工具选择决策点增加详细日志，便于后续优化
3. **架构审查**: 考虑召开技术评审会，明确Planner-Executor边界和责任
4. **回滚机制**: P1/P2阶段建议使用Feature Flag，出问题可快速回滚
5. **自动化测试**: 建立工具调用准确率的自动化测试套件

---

**结论**: P0方案投入产出比最高，建议立即开始实施。预期2-3人天投入，可提升工具选择准确率15-20%，降低无效调用率10%。

