# ClickHouse查询参数格式修复报告

## 📋 问题概述

访问文档详情页面时出现500错误：
```
TypeError: not all arguments converted during string formatting
```

错误发生在 `data/documents/{doc_id}` 路由，调用 `data_service.get_document()` 时。

## 🔍 根本原因

### 混合的参数格式 ❌

**文件**: `src/web/services/data_service.py`

代码中混用了三种ClickHouse参数格式：

1. **Positional parameters**: `WHERE doc_id = ?`
2. **String formatting**: `LIMIT {limit}`
3. **Named parameters**: `WHERE company_name ILIKE {search_pattern}`

**具体错误位置**:
```python
# 第97行 - 使用 ? 但传入 dict
WHERE doc_id = ?
parameters=[doc_id]  # positional ✓

# 第51行 - 使用 ? 但传入 dict
WHERE stock_code = ?
parameters={'stock_code': stock_code}  # named ✗ 不匹配
```

ClickHouse Python客户端的 `bind_query` 函数无法处理这种混用，导致字符串格式化失败。

## ✅ 修复措施

### 统一使用 Named Parameters 格式

ClickHouse推荐使用 `{param_name}` 格式的named parameters。

#### 修复1: get_document方法 (第97-100行)
**修改前**:
```python
WHERE doc_id = ?
parameters=[doc_id]
```

**修改后**:
```python
WHERE doc_id = {doc_id}
parameters={'doc_id': doc_id}
```

#### 修复2: get_sections方法 (第125-133行)
**修改前**:
```python
WHERE doc_id = ?
ORDER BY section_index
LIMIT {limit}  # 混合了f-string
parameters=[doc_id]
```

**修改后**:
```python
WHERE doc_id = {doc_id}
ORDER BY section_index
LIMIT {limit}
parameters={'doc_id': doc_id, 'limit': limit}
```

#### 修复3: get_documents方法 (第51-72行)
**修改前**:
```python
conditions.append("stock_code = ?")  # positional
conditions.append("document_type = ?")
parameters=list(params.values())  # positional values but keys in dict
```

**修改后**:
```python
conditions.append("stock_code = {stock_code}")  # named
conditions.append("document_type = {document_type}")
parameters=params  # pass dict directly
```

#### 修复4: get_statistics方法 (第198-209行)
**修改前**:
```python
WHERE created_at >= toDateTime('{last_week.strftime('%Y-%m-%d %H:%M:%S')}')  # f-string
```

**修改后**:
```python
WHERE created_at >= toDateTime({last_week})
parameters={'last_week': last_week.strftime('%Y-%m-%d %H:%M:%S')}
```

#### 修复5: check_duplicates方法 (第248-257行)
**修改前**:
```python
WHERE doc_id IN {tuple(doc_ids)}  # f-string with tuple
```

**修改后**:
```python
# ClickHouse IN子句不支持参数化，需手动构建
in_clause = ','.join([f"'{d}'" for d in doc_ids])
WHERE doc_id IN ({in_clause})
```

## 📊 修复对比

| 查询类型 | 修复前 | 修复后 |
|---------|--------|--------|
| **单参数查询** | `WHERE id = ?`<br/>`parameters=[id]` | `WHERE id = {id}`<br/>`parameters={'id': id}` |
| **多参数查询** | `WHERE a = ? AND b = ?`<br/>`parameters=[a, b]` | `WHERE a = {a} AND b = {b}`<br/>`parameters={'a': a, 'b': b}` |
| **LIMIT/OFFSET** | `f"LIMIT {limit}"` | `LIMIT {limit}`<br/>`parameters={..., 'limit': limit}` |
| **IN子句** | `IN {tuple(ids)}` | `IN ({','.join(...)})` |

## 🧪 测试验证

### 1. 语法检查
```bash
✅ Python语法检查通过
```

### 2. 导入测试
```python
from src.web.services.data_service import DataService
print("✅ DataService导入成功")
```

### 3. 预期行为
现在访问 `http://localhost:8000/data/documents/{doc_id}` 应该：
- ✅ 返回200状态码
- ✅ 返回JSON格式的文档信息
- ✅ 不再出现TypeError

## 🎯 ClickHouse参数格式最佳实践

### ✅ 推荐用法

1. **Named Parameters** (推荐):
```python
query = "SELECT * FROM table WHERE id = {id} AND name = {name}"
client.query(query, parameters={'id': 123, 'name': 'test'})
```

2. **Positional Parameters**:
```python
query = "SELECT * FROM table WHERE id = ? AND name = ?"
client.query(query, parameters=[123, 'test'])
```

3. **IN子句** (不支持参数化):
```python
ids = [1, 2, 3]
in_clause = ','.join(str(id) for id in ids)
query = f"SELECT * FROM table WHERE id IN ({in_clause})"
client.query(query)
```

### ❌ 避免用法

1. **混合格式**:
```python
# 错误：混用 ? 和 {name}
query = "WHERE id = ? AND name = {name}"
client.query(query, parameters={'name': 'test'})
```

2. **不安全拼接**:
```python
# 不推荐：可能有SQL注入风险
query = f"DELETE FROM table WHERE id = '{user_input}'"
```

## 📝 修复位置总结

| 行号 | 文件 | 修复内容 |
|------|------|----------|
| 51 | data_service.py | stock_code条件: `?` → `{stock_code}` |
| 55 | data_service.py | document_type条件: `?` → `{document_type}` |
| 61 | data_service.py | ORDER BY: f-string → `{limit}` |
| 63 | data_service.py | 参数传递: `list(params.values())` → `params` |
| 97 | data_service.py | WHERE doc_id: `?` → `{doc_id}` |
| 100 | data_service.py | 参数传递: `[doc_id]` → `{'doc_id': doc_id}` |
| 125 | data_service.py | WHERE doc_id: `?` → `{doc_id}` |
| 127 | data_service.py | LIMIT: f-string → `{limit}` |
| 130-133 | data_service.py | 参数传递: `[doc_id]` → `{doc_id, limit}` |
| 198-209 | data_service.py | 时间查询: f-string → `{last_week}` |
| 248-257 | data_service.py | IN查询: f-string → 手动构建 |

## 🚀 测试步骤

### 1. 启动服务
```bash
cd /Users/ericp/hkex-analysis
python3 -m uvicorn src.web.main:app --reload --port 8000
```

### 2. 测试文档列表
```bash
curl http://localhost:8000/data/documents
```

### 3. 测试文档详情 (之前失败)
```bash
curl http://localhost:8000/data/documents/00328_20251030_115620_91d5b824
```

### 4. 测试章节列表
```bash
curl http://localhost:8000/data/documents/{doc_id}/sections
```

## 📞 技术支持

**修复时间**: 2025-10-30 12:46:58
**修复状态**: ✅ 已完成
**测试状态**: ✅ 语法验证通过

如遇问题，请：
1. 检查Python语法: `python3 -m py_compile src/web/services/data_service.py`
2. 查看完整错误日志
3. 确认ClickHouse服务运行正常
