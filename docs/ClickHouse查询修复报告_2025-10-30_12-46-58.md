# ClickHouseæŸ¥è¯¢å‚æ•°æ ¼å¼ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

è®¿é—®æ–‡æ¡£è¯¦æƒ…é¡µé¢æ—¶å‡ºç°500é”™è¯¯ï¼š
```
TypeError: not all arguments converted during string formatting
```

é”™è¯¯å‘ç”Ÿåœ¨ `data/documents/{doc_id}` è·¯ç”±ï¼Œè°ƒç”¨ `data_service.get_document()` æ—¶ã€‚

## ğŸ” æ ¹æœ¬åŸå› 

### æ··åˆçš„å‚æ•°æ ¼å¼ âŒ

**æ–‡ä»¶**: `src/web/services/data_service.py`

ä»£ç ä¸­æ··ç”¨äº†ä¸‰ç§ClickHouseå‚æ•°æ ¼å¼ï¼š

1. **Positional parameters**: `WHERE doc_id = ?`
2. **String formatting**: `LIMIT {limit}`
3. **Named parameters**: `WHERE company_name ILIKE {search_pattern}`

**å…·ä½“é”™è¯¯ä½ç½®**:
```python
# ç¬¬97è¡Œ - ä½¿ç”¨ ? ä½†ä¼ å…¥ dict
WHERE doc_id = ?
parameters=[doc_id]  # positional âœ“

# ç¬¬51è¡Œ - ä½¿ç”¨ ? ä½†ä¼ å…¥ dict
WHERE stock_code = ?
parameters={'stock_code': stock_code}  # named âœ— ä¸åŒ¹é…
```

ClickHouse Pythonå®¢æˆ·ç«¯çš„ `bind_query` å‡½æ•°æ— æ³•å¤„ç†è¿™ç§æ··ç”¨ï¼Œå¯¼è‡´å­—ç¬¦ä¸²æ ¼å¼åŒ–å¤±è´¥ã€‚

## âœ… ä¿®å¤æªæ–½

### ç»Ÿä¸€ä½¿ç”¨ Named Parameters æ ¼å¼

ClickHouseæ¨èä½¿ç”¨ `{param_name}` æ ¼å¼çš„named parametersã€‚

#### ä¿®å¤1: get_documentæ–¹æ³• (ç¬¬97-100è¡Œ)
**ä¿®æ”¹å‰**:
```python
WHERE doc_id = ?
parameters=[doc_id]
```

**ä¿®æ”¹å**:
```python
WHERE doc_id = {doc_id}
parameters={'doc_id': doc_id}
```

#### ä¿®å¤2: get_sectionsæ–¹æ³• (ç¬¬125-133è¡Œ)
**ä¿®æ”¹å‰**:
```python
WHERE doc_id = ?
ORDER BY section_index
LIMIT {limit}  # æ··åˆäº†f-string
parameters=[doc_id]
```

**ä¿®æ”¹å**:
```python
WHERE doc_id = {doc_id}
ORDER BY section_index
LIMIT {limit}
parameters={'doc_id': doc_id, 'limit': limit}
```

#### ä¿®å¤3: get_documentsæ–¹æ³• (ç¬¬51-72è¡Œ)
**ä¿®æ”¹å‰**:
```python
conditions.append("stock_code = ?")  # positional
conditions.append("document_type = ?")
parameters=list(params.values())  # positional values but keys in dict
```

**ä¿®æ”¹å**:
```python
conditions.append("stock_code = {stock_code}")  # named
conditions.append("document_type = {document_type}")
parameters=params  # pass dict directly
```

#### ä¿®å¤4: get_statisticsæ–¹æ³• (ç¬¬198-209è¡Œ)
**ä¿®æ”¹å‰**:
```python
WHERE created_at >= toDateTime('{last_week.strftime('%Y-%m-%d %H:%M:%S')}')  # f-string
```

**ä¿®æ”¹å**:
```python
WHERE created_at >= toDateTime({last_week})
parameters={'last_week': last_week.strftime('%Y-%m-%d %H:%M:%S')}
```

#### ä¿®å¤5: check_duplicatesæ–¹æ³• (ç¬¬248-257è¡Œ)
**ä¿®æ”¹å‰**:
```python
WHERE doc_id IN {tuple(doc_ids)}  # f-string with tuple
```

**ä¿®æ”¹å**:
```python
# ClickHouse INå­å¥ä¸æ”¯æŒå‚æ•°åŒ–ï¼Œéœ€æ‰‹åŠ¨æ„å»º
in_clause = ','.join([f"'{d}'" for d in doc_ids])
WHERE doc_id IN ({in_clause})
```

## ğŸ“Š ä¿®å¤å¯¹æ¯”

| æŸ¥è¯¢ç±»å‹ | ä¿®å¤å‰ | ä¿®å¤å |
|---------|--------|--------|
| **å•å‚æ•°æŸ¥è¯¢** | `WHERE id = ?`<br/>`parameters=[id]` | `WHERE id = {id}`<br/>`parameters={'id': id}` |
| **å¤šå‚æ•°æŸ¥è¯¢** | `WHERE a = ? AND b = ?`<br/>`parameters=[a, b]` | `WHERE a = {a} AND b = {b}`<br/>`parameters={'a': a, 'b': b}` |
| **LIMIT/OFFSET** | `f"LIMIT {limit}"` | `LIMIT {limit}`<br/>`parameters={..., 'limit': limit}` |
| **INå­å¥** | `IN {tuple(ids)}` | `IN ({','.join(...)})` |

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. è¯­æ³•æ£€æŸ¥
```bash
âœ… Pythonè¯­æ³•æ£€æŸ¥é€šè¿‡
```

### 2. å¯¼å…¥æµ‹è¯•
```python
from src.web.services.data_service import DataService
print("âœ… DataServiceå¯¼å…¥æˆåŠŸ")
```

### 3. é¢„æœŸè¡Œä¸º
ç°åœ¨è®¿é—® `http://localhost:8000/data/documents/{doc_id}` åº”è¯¥ï¼š
- âœ… è¿”å›200çŠ¶æ€ç 
- âœ… è¿”å›JSONæ ¼å¼çš„æ–‡æ¡£ä¿¡æ¯
- âœ… ä¸å†å‡ºç°TypeError

## ğŸ¯ ClickHouseå‚æ•°æ ¼å¼æœ€ä½³å®è·µ

### âœ… æ¨èç”¨æ³•

1. **Named Parameters** (æ¨è):
```python
query = "SELECT * FROM table WHERE id = {id} AND name = {name}"
client.query(query, parameters={'id': 123, 'name': 'test'})
```

2. **Positional Parameters**:
```python
query = "SELECT * FROM table WHERE id = ? AND name = ?"
client.query(query, parameters=[123, 'test'])
```

3. **INå­å¥** (ä¸æ”¯æŒå‚æ•°åŒ–):
```python
ids = [1, 2, 3]
in_clause = ','.join(str(id) for id in ids)
query = f"SELECT * FROM table WHERE id IN ({in_clause})"
client.query(query)
```

### âŒ é¿å…ç”¨æ³•

1. **æ··åˆæ ¼å¼**:
```python
# é”™è¯¯ï¼šæ··ç”¨ ? å’Œ {name}
query = "WHERE id = ? AND name = {name}"
client.query(query, parameters={'name': 'test'})
```

2. **ä¸å®‰å…¨æ‹¼æ¥**:
```python
# ä¸æ¨èï¼šå¯èƒ½æœ‰SQLæ³¨å…¥é£é™©
query = f"DELETE FROM table WHERE id = '{user_input}'"
```

## ğŸ“ ä¿®å¤ä½ç½®æ€»ç»“

| è¡Œå· | æ–‡ä»¶ | ä¿®å¤å†…å®¹ |
|------|------|----------|
| 51 | data_service.py | stock_codeæ¡ä»¶: `?` â†’ `{stock_code}` |
| 55 | data_service.py | document_typeæ¡ä»¶: `?` â†’ `{document_type}` |
| 61 | data_service.py | ORDER BY: f-string â†’ `{limit}` |
| 63 | data_service.py | å‚æ•°ä¼ é€’: `list(params.values())` â†’ `params` |
| 97 | data_service.py | WHERE doc_id: `?` â†’ `{doc_id}` |
| 100 | data_service.py | å‚æ•°ä¼ é€’: `[doc_id]` â†’ `{'doc_id': doc_id}` |
| 125 | data_service.py | WHERE doc_id: `?` â†’ `{doc_id}` |
| 127 | data_service.py | LIMIT: f-string â†’ `{limit}` |
| 130-133 | data_service.py | å‚æ•°ä¼ é€’: `[doc_id]` â†’ `{doc_id, limit}` |
| 198-209 | data_service.py | æ—¶é—´æŸ¥è¯¢: f-string â†’ `{last_week}` |
| 248-257 | data_service.py | INæŸ¥è¯¢: f-string â†’ æ‰‹åŠ¨æ„å»º |

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡
```bash
cd /Users/ericp/hkex-analysis
python3 -m uvicorn src.web.main:app --reload --port 8000
```

### 2. æµ‹è¯•æ–‡æ¡£åˆ—è¡¨
```bash
curl http://localhost:8000/data/documents
```

### 3. æµ‹è¯•æ–‡æ¡£è¯¦æƒ… (ä¹‹å‰å¤±è´¥)
```bash
curl http://localhost:8000/data/documents/00328_20251030_115620_91d5b824
```

### 4. æµ‹è¯•ç« èŠ‚åˆ—è¡¨
```bash
curl http://localhost:8000/data/documents/{doc_id}/sections
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

**ä¿®å¤æ—¶é—´**: 2025-10-30 12:46:58
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ
**æµ‹è¯•çŠ¶æ€**: âœ… è¯­æ³•éªŒè¯é€šè¿‡

å¦‚é‡é—®é¢˜ï¼Œè¯·ï¼š
1. æ£€æŸ¥Pythonè¯­æ³•: `python3 -m py_compile src/web/services/data_service.py`
2. æŸ¥çœ‹å®Œæ•´é”™è¯¯æ—¥å¿—
3. ç¡®è®¤ClickHouseæœåŠ¡è¿è¡Œæ­£å¸¸
