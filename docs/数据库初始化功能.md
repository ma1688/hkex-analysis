# ClickHouse 数据库管理功能

## 功能概述

本功能为港股公告分析管理系统的 Web 界面添加了完整的 ClickHouse 数据库管理功能，包括初始化、重置、删除、优化、修复和备份等操作。用户可以通过 Web 界面轻松管理数据库表结构。

## 功能特性

### 1. 状态检查
- 实时检查数据库表是否存在
- 显示当前记录数量
- 提供详细的表结构状态信息

### 2. 基本操作
- **初始化数据库** - 创建必要的数据库表结构
- **检查状态** - 实时查看数据库状态

### 3. 数据操作
- **备份数据** - 创建表数据的备份副本
- **重置表** - 清空数据但保留表结构
- **优化表** - 执行表优化操作

### 4. 高级操作（危险操作）
- **删除表** - 永久删除表结构和所有数据
- **重建表** - 先删除后重新创建表

### 5. 修复操作
- **修复表结构** - 重新创建表结构（需确保无数据）

## 表结构设计

### documents_v2 表
```sql
CREATE TABLE documents_v2
(
    doc_id String,
    stock_code String,
    company_name String,
    title String,
    document_type String,
    document_subtype String,
    announcement_date DateTime64(3),
    section_count Int32,
    file_path String,
    metadata JSON,
    created_at DateTime64(3)
)
ENGINE = MergeTree
ORDER BY (stock_code, announcement_date)
TTL announcement_date + INTERVAL 10 YEAR
```

### document_sections 表
```sql
CREATE TABLE document_sections
(
    section_id String,
    doc_id String,
    section_type String,
    section_title String,
    section_index Int32,
    content String,
    char_count Int32,
    metadata JSON
)
ENGINE = MergeTree
ORDER BY (doc_id, section_index)
TTL (toDate(doc_id) + INTERVAL 10 YEAR)
```

## 使用方式

### 通过 Web 界面

1. 访问系统主页：http://localhost:8000
2. 点击左侧导航菜单中的 **"数据库初始化"**
3. 在数据库管理操作区域选择相应功能：
   - **基本操作**：初始化、检查状态
   - **数据操作**：备份数据、重置表、优化表
   - **高级操作**：删除表、重建表（需确认）
   - **修复操作**：修复表结构

### 通过 API

#### 检查数据库状态
```bash
curl -X GET http://localhost:8000/data/init/status
```

响应示例：
```json
{
  "status": "ok",
  "tables_exist": {
    "documents_v2": true,
    "document_sections": true
  },
  "record_counts": {
    "documents": 100,
    "sections": 500
  }
}
```

#### 初始化数据库
```bash
curl -X POST http://localhost:8000/data/init
```

响应示例：
```json
{
  "message": "数据库初始化成功",
  "tables_created": ["documents_v2", "document_sections"]
}
```

#### 备份数据
```bash
curl -X POST http://localhost:8000/data/backup
```

响应示例：
```json
{
  "message": "表备份成功"
}
```

#### 重置表（清空数据）
```bash
curl -X POST http://localhost:8000/data/reset
```

响应示例：
```json
{
  "message": "表重置成功，所有数据已清空，表结构保留"
}
```

#### 优化表
```bash
curl -X POST http://localhost:8000/data/optimize
```

#### 修复表结构
```bash
curl -X POST http://localhost:8000/data/repair
```

#### 删除表（危险操作）
```bash
curl -X POST http://localhost:8000/data/drop
```

#### 重建表（危险操作）
```bash
curl -X POST http://localhost:8000/data/recreate
```

## 完整 API 端点

| 方法 | 路径 | 功能 | 说明 |
|------|------|------|------|
| GET | `/data/init/status` | 检查状态 | 获取数据库表存在状态和记录数 |
| POST | `/data/init` | 初始化 | 创建数据库表结构 |
| POST | `/data/reset` | 重置 | 清空数据，保留表结构 |
| POST | `/data/drop` | 删除 | 永久删除表结构和数据 |
| POST | `/data/recreate` | 重建 | 先删除后重新创建表 |
| POST | `/data/optimize` | 优化 | 执行表优化操作 |
| POST | `/data/repair` | 修复 | 修复表结构 |
| POST | `/data/backup` | 备份 | 创建数据备份 |

## 操作说明

### 初始化数据库
- **用途**：首次使用或重新创建表结构
- **安全性**：安全，表已存在时会跳过创建
- **影响**：不影响现有数据

### 备份数据
- **用途**：在执行危险操作前备份数据
- **安全性**：安全，只读操作
- **影响**：创建备份表，原数据不变
- **备份表名格式**：`documents_v2_backup_YYYYMMDD_HHMMSS`

### 重置表
- **用途**：清空所有数据，重新开始
- **安全性**：危险，会删除所有数据
- **影响**：删除所有记录，保留表结构
- **确认要求**：需要输入 "RESET TABLES" 确认

### 优化表
- **用途**：提高查询性能
- **安全性**：安全
- **影响**：重新整理表数据，可能需要一些时间

### 删除表
- **用途**：彻底删除表（慎用）
- **安全性**：极危险，永久删除
- **影响**：删除表结构和所有数据
- **确认要求**：需要输入 "DROP TABLES" 确认

### 重建表
- **用途**：重新创建表结构
- **安全性**：极危险，会删除所有数据
- **影响**：先删除表和数据，然后重新创建
- **确认要求**：需要输入 "RECREATE TABLES" 确认

### 修复表结构
- **用途**：修复损坏的表结构
- **安全性**：有风险，会重建表
- **影响**：仅在表为空时可用
- **前提**：确保表中没有数据

## 技术实现

### 后端实现

1. **DataService 类** (`src/web/services/data_service.py`)
   - `initialize_database()` - 初始化数据库表
   - `check_database_status()` - 检查数据库状态
   - `reset_tables()` - 重置表（清空数据）
   - `drop_tables()` - 删除表
   - `recreate_tables()` - 重新创建表
   - `optimize_tables()` - 优化表
   - `repair_tables()` - 修复表结构
   - `backup_tables()` - 备份表数据

2. **API 路由** (`src/web/routes/data.py`)
   - `GET /data/init/status` - 检查状态
   - `POST /data/init` - 初始化
   - `POST /data/reset` - 重置表
   - `POST /data/drop` - 删除表
   - `POST /data/recreate` - 重建表
   - `POST /data/optimize` - 优化表
   - `POST /data/repair` - 修复表
   - `POST /data/backup` - 备份表

3. **页面路由** (`src/web/main.py`)
   - `GET /init` - 初始化页面

### 前端实现

1. **页面模板** (`src/web/templates/init.html`)
   - 状态检查界面
   - 分类操作按钮（基本、数据、高级、修复）
   - 确认模态框（备份、重置、删除、重建）
   - 表结构说明

2. **JavaScript 功能**
   - AJAX 请求处理
   - 动态状态更新
   - 模态框控制
   - 确认流程处理
   - 结果显示

## 安全措施

### 危险操作保护
1. **双重确认**：危险操作需要输入特定字符串确认
2. **模态框提示**：所有危险操作都有专门的确认对话框
3. **警告提示**：明确说明操作后果
4. **输入验证**：必须输入正确的确认字符串才能执行

### 数据安全
1. **备份优先**：建议先备份再执行危险操作
2. **表存在检查**：操作前检查表是否存在
3. **原子操作**：使用事务保证操作完整性
4. **错误回滚**：失败时自动回滚到安全状态

## 注意事项

### 数据库连接
- 确保 ClickHouse 服务已启动且配置正确
- 检查 `.env` 文件中的数据库配置
- 确认网络连通性

### 权限要求
- **初始化/创建表**：需要 CREATE 权限
- **删除表**：需要 DROP 权限
- **重置表**：需要 ALTER 权限
- **备份表**：需要 SELECT 权限

### 操作风险
- **低风险**：初始化、检查状态、优化、修复（无数据时）
- **中风险**：重置表、备份表
- **高风险**：删除表、重建表

### 最佳实践
1. **首次使用**：先检查状态 → 初始化 → 备份
2. **日常维护**：定期优化表 → 定期备份
3. **危险操作前**：先备份 → 确认操作必要性 → 执行
4. **故障排查**：检查状态 → 修复 → 重启服务

## 故障排除

### 检查连接失败
- 验证 ClickHouse 服务是否运行
- 检查 `.env` 文件中的数据库配置
- 确认网络连通性
- 查看服务器日志获取详细信息

### 权限不足
- 确认 ClickHouse 用户权限
- 检查用户是否具有相应表的权限
- 联系数据库管理员获取必要权限

### 操作失败
- 查看服务器日志获取具体错误信息
- 确认磁盘空间是否充足
- 检查 ClickHouse 版本兼容性

### 数据恢复
- 使用备份表恢复数据
- 从备份表复制数据到原表
- 示例：
```sql
INSERT INTO documents_v2 SELECT * FROM documents_v2_backup_20241201_143000
```

## 相关文件

- `src/web/services/data_service.py` - 数据服务实现
- `src/web/routes/data.py` - API 路由
- `src/web/templates/init.html` - 初始化页面
- `src/web/main.py` - 页面路由
- `src/web/templates/base.html` - 导航菜单
