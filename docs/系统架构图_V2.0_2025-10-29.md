# 港股公告智能问答系统 - 完整架构图 V2.0

> 更新日期：2025-10-29
> 版本：V2.0（配置驱动 + 性能优化版）

---

## 🏗️ 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            用户交互层 (User Interface)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  CLI v2 (推荐)          │  API REST              │  CLI v1 (旧版)           │
│  - ask命令              │  - POST /api/v1/ask    │  - 已备份                │
│  - chat命令             │  - GET /health         │  - commands.py.backup    │
│  - tools-list           │  - WebSocket支持       │                          │
│  - config查看           │                        │                          │
└──────────────┬──────────┴────────────┬───────────┴──────────────────────────┘
               │                       │
               ▼                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Agent编排层 (Agent Orchestration)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐           │
│  │              Supervisor (LangGraph状态机)                     │           │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │           │
│  │  │ Planner  │→ │ Document │→ │Reflector │→ │ Context  │    │           │
│  │  │ 任务规划  │  │  Agent   │  │ 质量评估  │  │ 上下文   │    │           │
│  │  └──────────┘  │  执行     │  └──────────┘  │ 注入器   │    │           │
│  │      ↓         └──────────┘       ↓         └──────────┘    │           │
│  │  ┌──────────────────────────────────────────────────────┐   │           │
│  │  │        State Management (状态管理)                    │   │           │
│  │  │  - query, plan, results, reflection                  │   │           │
│  │  │  - conversation_history, user_profile                │   │           │
│  │  └──────────────────────────────────────────────────────┘   │           │
│  └──────────────────────────────────────────────────────────────┘           │
│                                                                               │
│  配置文件:                                                                    │
│  • config/agents.yaml - Agent行为配置                                        │
│  • config/agent_optimization.yaml - 性能优化配置                             │
│  • config/prompts/prompts.yaml - 系统提示词                                  │
└───────────────────────────────┬───────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          工具层 (Tools Layer)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Layer 1: 基础检索层 (优先使用，速度快)                                │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  结构化数据工具                      │  文档元信息工具                 │   │
│  │  • query_placing_data (配售)        │  • search_documents            │   │
│  │  • query_ipo_data (IPO)             │    (搜索公告元信息)             │   │
│  │  • query_rights_data (供股)         │                                │   │
│  │  • query_consolidation_data (合股)  │                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Layer 2: 内容获取层 (需要原文时使用)                                  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  • retrieve_chunks - 获取公告详细内容块                               │   │
│  │    (支持doc_id、stock_code、keyword三种检索方式)                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Layer 3: 分析处理层 (深度分析)                                        │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  • synthesize_chunks - 合成多个chunks为连贯文本                       │   │
│  │  • extract_key_info - 从文本提取结构化信息                            │   │
│  │  • compare_data - 对比两组数据                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Layer 4: 辅助工具层                                                   │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  时间感知: get_current_time, get_market_time, calculate_time_diff    │   │
│  │  数据增强: enhance_market_data, get_real_time_stock_info             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  配置文件:                                                                    │
│  • config/tools.yaml - 工具执行配置                                          │
│  • src/tools/loader.py - 工具自动加载器                                      │
└───────────────────────────────┬───────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        数据层 (Data Layer)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌────────────────────────────────┐  ┌────────────────────────────────┐    │
│  │      V1.0 数据表（现有）         │  │      V2.0 数据表（新增）         │    │
│  ├────────────────────────────────┤  ├────────────────────────────────┤    │
│  │  • pdf_documents               │  │  • documents_v2                │    │
│  │    (文档元信息)                  │  │    (支持document_type)         │    │
│  │  • pdf_chunks                  │  │  • document_sections           │    │
│  │    (固定大小切块)                │  │    (章节级别，支持section_type) │    │
│  │                                 │  │  • section_entities            │    │
│  │  • ipo_data                    │  │    (实体提取，可选)             │    │
│  │  • placing_data                │  │                                │    │
│  │  • rights_data                 │  │  **完全独立，不影响V1.0**       │    │
│  │  • consolidation_data          │  │                                │    │
│  └────────────────────────────────┘  └────────────────────────────────┘    │
│                                                                               │
│  数据库: ClickHouse 23.8.16.16                                               │
│  配置: src/utils/clickhouse.py                                               │
└───────────────────────────────┬───────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      文档处理流水线 (Document Pipeline)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  V1.0 流水线 (现有系统)                                                       │
│  ┌──────┐  ┌──────────┐  ┌──────────┐                                      │
│  │ PDF  │→ │ 固定切块  │→ │ 向量化   │→ pdf_chunks                          │
│  └──────┘  └──────────┘  └──────────┘                                      │
│                                                                               │
│  V2.0 流水线 (配置驱动) ⭐                                                    │
│  ┌──────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ PDF  │→ │ 文档类型检测  │→ │ 章节识别切分  │→ │ V2.0独立表   │          │
│  └──────┘  └──────────────┘  └──────────────┘  └──────────────┘          │
│      │           │                   │                                       │
│      │           ▼                   ▼                                       │
│      │     DocumentType        ChapterProcessor                              │
│      │     Detector            (LLM语义+关键词)                              │
│      │     (关键词匹配)                                                       │
│      │                                                                       │
│      └─→ 配置文件驱动:                                                       │
│           • config/document_types/rights_issue.yaml (供股-17种章节)          │
│           • config/document_types/placing.yaml (配售-20种章节)               │
│           • 可扩展: ipo.yaml, financial_report.yaml, mna.yaml               │
│                                                                               │
│  核心模块:                                                                    │
│  • src/pipeline/document_type_detector.py - 文档类型检测                     │
│  • src/pipeline/chapter_processor.py - 章节识别与切分                        │
│  • src/pipeline/section_storage_v2.py - V2.0存储接口                         │
│  • src/pipeline/document_retrieval_v2.py - V2.0检索接口                      │
│  • src/pipeline/pdf_pipeline_v2.py - 完整流水线                              │
│  • src/pipeline/batch_processor.py - 异步批量处理                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                        LLM管理层 (LLM Management)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────────────┐      │
│  │                    LLMManager (统一接口)                          │      │
│  ├──────────────────────────────────────────────────────────────────┤      │
│  │  • 主提供商: 硅基流动 (SiliconFlow)                               │      │
│  │    - FAST_MODEL: deepseek-chat                                   │      │
│  │    - STRONG_MODEL: deepseek-reasoner                             │      │
│  │                                                                   │      │
│  │  • 备用提供商: OpenAI                                             │      │
│  │    - gpt-4o-mini                                                 │      │
│  │    - gpt-4o                                                      │      │
│  │                                                                   │      │
│  │  功能:                                                            │      │
│  │  ✓ 自动主备切换 (主挂→备)                                         │      │
│  │  ✓ 计费追踪                                                       │      │
│  │  ✓ 错误重试                                                       │      │
│  └──────────────────────────────────────────────────────────────────┘      │
│                                                                               │
│  配置: src/llm/manager.py                                                    │
│  环境变量: SILICONFLOW_API_KEY, OPENAI_API_KEY                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                        记忆与学习层 (Memory & Learning)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌─────────────────┐  │
│  │  短期记忆 (Short-term)│  │  长期记忆 (Long-term) │  │  经验学习       │  │
│  ├──────────────────────┤  ├──────────────────────┤  ├─────────────────┤  │
│  │  • 对话历史           │  │  • 用户画像           │  │  • 成功案例库   │  │
│  │  • 上下文窗口         │  │  • 知识提取           │  │  • 失败案例库   │  │
│  │  • 最近N条消息        │  │  • 持久化存储         │  │  • 最佳实践提取 │  │
│  └──────────────────────┘  └──────────────────────┘  └─────────────────┘  │
│                                                                               │
│  5层上下文构建:                                                               │
│  Layer 1: 对话历史 → Layer 2: 用户画像 → Layer 3: 领域知识                   │
│  → Layer 4: 相关性 → Layer 5: 历史经验 ⭐                                    │
│                                                                               │
│  配置: config/agents.yaml (memory, context, experience)                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                        优化组件 (Optimization Components)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │  工具验证器     │  │  动态规划器     │  │  执行监控器     │               │
│  │ ToolValidator  │  │ DynamicPlanner │  │ExecutionMonitor│               │
│  ├────────────────┤  ├────────────────┤  ├────────────────┤               │
│  │ • 参数验证      │  │ • 计划调整      │  │ • 质量追踪      │               │
│  │ • 格式转换      │  │ • 错误恢复      │  │ • 性能分析      │               │
│  │ • 自动修正      │  │ • 工具fallback  │  │ • 报告生成      │               │
│  └────────────────┘  └────────────────┘  └────────────────┘               │
│                                                                               │
│  核心优化 (2025-10-29):                                                      │
│  • 反思循环: 3次 → 1次 (减少66%)                                             │
│  • 质量阈值: 0.8 → 0.7 (更容易通过)                                          │
│  • 重试次数: 2次 → 1次 (减少50%)                                             │
│  • 规划复杂度: complex → moderate                                            │
│  • 超时缩短: 25-50%                                                          │
│  • 提示词快速响应策略                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 数据流示意图

### 典型查询流程（混合查询）

```
用户: "00328最新供股公告内容摘要"
   │
   ▼
┌─────────────────────────┐
│ 1. CLI接收查询           │
│    ask "00328最新供股..." │
└────────────┬────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ 2. Supervisor启动                    │
│    • 初始化State                     │
│    • 加载上下文(5层)                 │
└────────────┬────────────────────────┘
             │
             ▼
┌──────────────────────────────────────┐
│ 3. Planner规划 (快速模式⚡)          │
│    识别: 混合查询                     │
│    步骤:                              │
│    1️⃣ get_current_time              │
│    2️⃣ query_rights_data (结构化)    │
│    3️⃣ search_documents (获取doc_id) │
│    4️⃣ retrieve_chunks (原文)        │
│    5️⃣ synthesize_chunks (摘要)      │
└────────────┬─────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ 4. Document Agent执行                │
│    ┌───────────────────────────┐   │
│    │ 步骤1: get_current_time   │   │
│    │  → 2025-10-29 14:30      │   │
│    └───────────┬───────────────┘   │
│                ▼                    │
│    ┌───────────────────────────┐   │
│    │ 步骤2: query_rights_data  │   │
│    │  (00328.hk → 00328.hk)   │   │
│    │  → 供股价: 3.24港元       │   │
│    │  → 供股比例: 1:4          │   │
│    │  → 日期: 2025-07-08       │   │
│    └───────────┬───────────────┘   │
│                ▼                    │
│    ┌───────────────────────────┐   │
│    │ 步骤3: search_documents   │   │
│    │  (00328.hk → 00328)      │   │
│    │  → doc_id: doc_196b...   │   │
│    └───────────┬───────────────┘   │
│                ▼                    │
│    ┌───────────────────────────┐   │
│    │ 步骤4: retrieve_chunks    │   │
│    │  → 30个内容块             │   │
│    └───────────┬───────────────┘   │
│                ▼                    │
│    ┌───────────────────────────┐   │
│    │ 步骤5: synthesize_chunks  │   │
│    │  → 连贯摘要               │   │
│    └───────────────────────────┘   │
└────────────┬─────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ 5. Reflector评估 (快速模式⚡)        │
│    • 完整性: 0.9                     │
│    • 准确性: 0.85                    │
│    • 一致性: 0.9                     │
│    • 综合质量分数: 0.88              │
│    ✅ ≥ 0.7 通过！                   │
└────────────┬─────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ 6. 返回最终结果                      │
│    ✓ 结构化数据 (供股价、比例)       │
│    ✓ 原文摘要 (背景、资金用途)       │
│    ✓ 时间表 (认购期、除权日)         │
└─────────────────────────────────────┘
```

---

## 🔧 配置文件体系

```
config/
├── agents.yaml                    # Agent行为配置
│   ├── supervisor (监督器)
│   │   ├── max_reflection_iterations: 1 ⚡
│   │   ├── planning_timeout: 30s ⚡
│   │   └── reflection_threshold: 0.7 ⚡
│   ├── sub_agents (子Agent)
│   │   ├── document (启用)
│   │   ├── market (预留)
│   │   ├── financial (预留)
│   │   └── news (预留)
│   ├── memory (记忆配置)
│   │   ├── short_term
│   │   ├── long_term
│   │   └── experience ⭐
│   └── context (上下文配置)
│       └── 5层上下文构建
│
├── agent_optimization.yaml        # 优化配置
│   ├── tool_validation (工具验证)
│   ├── dynamic_planning (动态规划)
│   │   └── max_plan_complexity: moderate ⚡
│   ├── execution_monitoring (执行监控)
│   ├── error_recovery (错误恢复)
│   │   └── max_retries: 1 ⚡
│   └── performance (性能优化)
│       └── timeout: 45s total, 15s per tool ⚡
│
├── prompts/
│   └── prompts.yaml               # 提示词配置 ⭐
│       ├── planner_system_prompt
│       │   └── ⚡ 快速响应优先
│       ├── document_agent_system_prompt
│       │   ├── 4层工具体系
│       │   ├── 决策树
│       │   ├── Few-Shot示例
│       │   └── ⚡ 快速响应原则
│       └── reflector_system_prompt
│           └── ⚡ 快速评估原则 (阈值0.7)
│
├── tools.yaml                     # 工具配置
│   ├── custom_tools (自定义工具)
│   ├── tool_execution
│   │   ├── max_retries: 1 ⚡
│   │   └── retry_delay: 0.5s ⚡
│   └── database_tools (缓存配置)
│
└── document_types/                # V2.0文档类型配置 ⭐
    ├── rights_issue.yaml          # 供股(17种章节)
    ├── placing.yaml               # 配售(20种章节)
    ├── ipo.yaml                   # IPO(未来)
    ├── financial_report.yaml      # 财报(未来)
    └── mna.yaml                   # 收购(未来)
```

---

## 🚀 性能优化总结 (2025-10-29)

| 优化项 | 优化前 | 优化后 | 提升 |
|--------|-------|--------|------|
| 反思循环 | 3次 | 1次 | 66% ⬇️ |
| 质量阈值 | 0.8 | 0.7 | 通过率⬆️ |
| 重试次数 | 2次 | 1次 | 50% ⬇️ |
| 规划超时 | 60s | 30s | 50% ⬇️ |
| 总超时 | 60s | 45s | 25% ⬇️ |
| 工具超时 | 30s | 15s | 50% ⬇️ |

**预期效果**：
- 简单查询：15秒 → **5-8秒** (60-70%提升)
- 复杂查询：50秒 → **25-40秒** (30-40%提升)

---

## 📈 系统特性总览

### V1.0 特性 (现有)
- ✅ 固定大小文档切块
- ✅ 结构化数据查询 (IPO/配售/供股/合股)
- ✅ 文档检索与合成
- ✅ LangGraph多Agent编排
- ✅ 主备LLM自动切换
- ✅ CLI命令行工具

### V2.0 新增特性 ⭐
- ✅ **配置驱动架构** - 所有提示词、行为配置化
- ✅ **章节级别切分** - 按业务语义切分（非固定大小）
- ✅ **多文档类型支持** - 供股/配售/IPO等独立配置
- ✅ **独立数据库设计** - 完全隔离，不影响V1.0
- ✅ **智能文档类型检测** - 自动识别公告类型
- ✅ **异步批量处理** - 高效处理大量PDF
- ✅ **记忆与学习增强** - 5层上下文+经验学习
- ✅ **性能优化** - 60-70%速度提升

### 2025-10-29 修复与优化 🔧
- ✅ **stock_code格式兼容** - 智能处理 00328/.hk后缀
- ✅ **快速响应策略** - 提示词优化，简单查询加速
- ✅ **配置全面优化** - 15项配置调优
- ✅ **工具格式转换** - 自动适配数据库格式差异

---

## 🗂️ 目录结构

```
hkex-analysis/
├── config/                        # 配置文件（配置驱动核心）
│   ├── agents.yaml
│   ├── agent_optimization.yaml
│   ├── tools.yaml
│   ├── prompts/
│   │   └── prompts.yaml
│   └── document_types/
│       ├── rights_issue.yaml
│       └── placing.yaml
│
├── src/
│   ├── agent/                     # Agent模块
│   │   ├── supervisor.py          # LangGraph状态机
│   │   ├── planner.py             # 任务规划
│   │   ├── document_agent.py      # 文档分析Agent
│   │   ├── reflector.py           # 质量评估
│   │   ├── context_injector.py    # 上下文注入
│   │   ├── tool_validator.py      # 工具验证 ⚡
│   │   ├── dynamic_planner.py     # 动态规划 ⚡
│   │   └── execution_monitor.py   # 执行监控 ⚡
│   │
│   ├── api/                       # REST API
│   │   └── main.py
│   │
│   ├── cli/                       # 命令行工具
│   │   ├── v2/                    # CLI v2（推荐）⭐
│   │   │   ├── commands/          # ask, chat, tools, config
│   │   │   ├── services/          # agent_service, context_service
│   │   │   └── presenters/        # 输出展示
│   │   └── commands.py.backup     # CLI v1备份
│   │
│   ├── tools/                     # 工具集
│   │   ├── structured_data.py     # 结构化数据查询 🔧
│   │   ├── document_retrieval.py  # 文档检索 🔧
│   │   ├── synthesis.py           # 内容合成
│   │   ├── data_enhancement.py    # 数据增强
│   │   ├── time_utils.py          # 时间工具
│   │   ├── loader.py              # 工具加载器
│   │   └── custom/                # 自定义工具目录
│   │
│   ├── pipeline/                  # V2.0文档处理流水线 ⭐
│   │   ├── document_type_detector.py
│   │   ├── chapter_processor.py
│   │   ├── section_storage_v2.py
│   │   ├── document_retrieval_v2.py
│   │   ├── pdf_pipeline_v2.py
│   │   └── batch_processor.py
│   │
│   ├── llm/                       # LLM管理
│   │   └── manager.py
│   │
│   ├── config/                    # 配置加载
│   │   └── settings.py
│   │
│   └── utils/                     # 工具模块
│       ├── clickhouse.py          # 数据库客户端
│       ├── prompts.py             # 提示词加载器
│       └── text_cleaner.py        # 文本清理
│
├── tests/                         # 测试
│   ├── test_v2_integration.py     # V2.0集成测试 ✅
│   ├── test_batch_processing.py   # 批量处理测试
│   └── test_agent_optimizations.py # 优化测试
│
├── scripts/                       # 脚本
│   ├── create_tables_v2.sql       # V2.0建表脚本
│   └── migrate_v1_to_v2.py        # 迁移脚本
│
├── docs/                          # 文档
│   ├── 系统架构图_V2.0_2025-10-29.md ⭐ (本文件)
│   ├── V2.0完整测试指南.md
│   └── 执行报告/
│
├── HKEX/                          # 原始PDF数据
│   └── 00328/
│
└── pyproject.toml                 # 项目配置
```

---

## 🔑 关键技术栈

| 层次 | 技术 | 用途 |
|------|------|------|
| **Agent编排** | LangGraph | 状态机工作流 |
| **LLM** | SiliconFlow (DeepSeek) | 主模型提供商 |
|  | OpenAI (GPT-4o) | 备用提供商 |
| **数据库** | ClickHouse 23.8 | 列式存储 |
| **API框架** | FastAPI | REST API |
| **CLI** | Click | 命令行工具 |
| **配置** | YAML | 配置驱动 |
| **测试** | Pytest | 单元测试 |

---

## 📝 使用示例

### 简单查询（单步）
```bash
hkex-agent ask "查询00328供股数据"
# 执行流程：Planner(1步) → query_rights_data → Reflector → 返回
# 耗时：~5-8秒 ⚡
```

### 混合查询（5步）
```bash
hkex-agent ask "00328最新供股公告内容摘要"
# 执行流程：
#   1️⃣ get_current_time
#   2️⃣ query_rights_data (结构化)
#   3️⃣ search_documents (doc_id)
#   4️⃣ retrieve_chunks (原文)
#   5️⃣ synthesize_chunks (摘要)
# 耗时：~25-40秒
```

### 对比查询（多步）
```bash
hkex-agent ask "对比腾讯和阿里最近配售条款"
# 执行流程：
#   1️⃣ query_placing_data(00700.hk)
#   2️⃣ query_placing_data(09988.hk)
#   3️⃣ compare_data
# 耗时：~15-20秒
```

---

## 🎯 架构设计原则

1. **配置驱动** - 零硬编码，所有行为可配置
2. **层次清晰** - 用户层→Agent层→工具层→数据层
3. **独立隔离** - V1.0/V2.0数据完全隔离
4. **可扩展性** - 新文档类型/工具/Agent易于添加
5. **性能优先** - 快速响应，减少不必要的中间步骤 ⚡
6. **容错健壮** - 主备切换、错误重试、降级策略
7. **可观测性** - 日志、监控、性能分析

---

## 📚 相关文档

- [CLAUDE.md](../CLAUDE.md) - 开发指南
- [V2.0完整测试指南.md](V2.0完整测试指南.md)
- [V1.0到V2.0迁移指南.md](V1.0到V2.0迁移指南.md)
- [执行报告/2025-10-29_反思学习能力增强报告.md](执行报告/2025-10-29_反思学习能力增强报告.md)
- [执行报告/2025-10-28_V2.0真实数据库集成测试报告.md](执行报告/2025-10-28_V2.0真实数据库集成测试报告.md)

---

**版本历史**：
- V1.0 (2025-10-25): 初始版本，固定切块
- V2.0 (2025-10-28): 配置驱动 + 章节级切分
- V2.0.1 (2025-10-29): stock_code格式修复 + 性能优化 🚀

**当前状态**: ✅ 生产就绪

