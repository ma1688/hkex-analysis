#!/usr/bin/env python3
"""
æ–‡æ¡£è¿‡æ»¤å™¨ - åˆ¤æ–­PDFæ–‡æ¡£æ˜¯å¦åº”è¯¥è¿›è¡Œåˆ‡å—å¤„ç†
ç”¨æ³•ï¼špython document_filter.py <pdf_path>
è¿”å›ï¼š0=åº”è¯¥å¤„ç†ï¼Œ1=åº”è¯¥è·³è¿‡
"""

import sys
import re
from pathlib import Path

# ====== è·³è¿‡è§„åˆ™ï¼ˆä¸è¿›è¡Œåˆ‡å—çš„æ–‡æ¡£ç±»å‹ï¼‰======

# 1. æ–‡ä»¶åå…³é”®è¯é»‘åå•ï¼ˆåŒ…å«è¿™äº›å…³é”®è¯çš„æ–‡æ¡£ä¼šè¢«è·³è¿‡ï¼‰
SKIP_KEYWORDS = [
    # å®šæœŸæŠ¥å‘Šç±»
    'æœˆæŠ¥è¡¨', 'æœˆå ±è¡¨',
    'å­£æŠ¥', 'å­£å ±',
    'åŠå¹´æŠ¥', 'åŠå¹´å ±',
    'å¹´æŠ¥', 'å¹´å ±',
    'ç¯å¢ƒã€ç¤¾ä¼šåŠç®¡æ²»', 'ç¯å¢ƒç¤¾ä¼šç®¡æ²»', 'ESG',
    
    # ä¼šè®®é€šçŸ¥ç±»
    'è‚¡ä¸œå¤§ä¼šé€šå‘Š', 'è‚¡æ±å¤§æœƒé€šå‘Š',
    'è‚¡ä¸œå‘¨å¹´å¤§ä¼š', 'è‚¡æ±é€±å¹´å¤§æœƒ',
    'è‚¡ä¸œç‰¹åˆ«å¤§ä¼š', 'è‚¡æ±ç‰¹åˆ¥å¤§æœƒ',
    'é€šå‘Š', 'é€šçŸ¥',
    'å§”ä»»ä»£è¡¨è¡¨æ ¼', 'ä»£è¡¨å§”ä»»è¡¨æ ¼',
    
    # ç®¡ç†æ€§æ–‡ä»¶
    'å±•ç¤ºæ–‡ä»¶', 'å±•ç¤ºæ¡£æ¡ˆ',
    'é€å‘ˆ', 'é€äº¤',
    'æ›´æ”¹', 'æ›´æ¢', 'æ›´æ›',
    'å˜æ›´', 'è®Šæ›´',
    
    # æ—¥å¸¸è¿è¥ç±»
    'è‘£äº‹ä¼šä¼šè®®', 'è‘£äº‹æœƒæœƒè­°',
    'è‘£äº‹åå•', 'è‘£äº‹åå–®',
    'ä¸šåŠ¡å‘å±•æœ€æ–°æƒ…å†µ', 'æ¥­å‹™ç™¼å±•æœ€æ–°æƒ…æ³',
    
    # è¡¨æ ¼ç±»
    'æœˆä»½ä¹‹è‚¡ä»½å‘è¡Œäººçš„è¯åˆ¸å˜åŠ¨æœˆæŠ¥è¡¨',
    'è­‰åˆ¸è®Šå‹•æœˆå ±è¡¨',
    
    # å…¶ä»–æ‚é¡¹
    'ç›ˆåˆ©è­¦å‘Š', 'ç›ˆè­¦',
    'æš‚åœåŠç†è¿‡æˆ·ç™»è®°æ‰‹ç»­', 'æš«åœè¾¦ç†éæˆ¶',
]

# 2. æ–‡ä»¶åæ¨¡å¼é»‘åå•ï¼ˆåŒ¹é…è¿™äº›æ­£åˆ™æ¨¡å¼çš„ä¼šè¢«è·³è¿‡ï¼‰
SKIP_PATTERNS = [
    r'^\d{4}-\d{2}-\d{2}_\d{5}_.*_æœˆæŠ¥è¡¨',  # æœˆæŠ¥è¡¨
    r'^\d{4}-\d{2}-\d{2}_\d{5}_.*_æœˆå ±è¡¨',
    r'^\d{4}-\d{2}-\d{2}_\d{5}_.*_å§”ä»»ä»£è¡¨è¡¨æ ¼',  # ä»£è¡¨å§”ä»»
    r'^\d{4}-\d{2}-\d{2}_\d{5}_.*_å±•ç¤ºæ–‡ä»¶',  # å±•ç¤ºæ–‡ä»¶
    r'^\d{4}-\d{2}-\d{2}_\d{5}_.*_è‘£äº‹åå•',  # è‘£äº‹åå•
    r'^\d{4}-\d{2}-\d{2}_\d{5}_.*_æ›´[æ¢æ›æ”¹è®Š]',  # å„ç§æ›´æ”¹
]

# 3. åº”è¯¥å¤„ç†çš„æ–‡æ¡£ç±»å‹ç™½åå•ï¼ˆä¼˜å…ˆçº§é«˜äºé»‘åå•ï¼‰
PROCESS_KEYWORDS = [
    'ä¾›è‚¡',
    'é…å”®',
    'IPO',
    'æ‹›è‚¡',
    'ä¸Šå¸‚',
    'åˆè‚¡',
    'è‚¡æœ¬æ•´åˆ',
    'æ”¶è´­', 'æ”¶è³¼',
    'å‡ºå”®', 'è™•ç½®',
    'é¡»äºˆæŠ«éœ²äº¤æ˜“', 'é ˆäºˆæŠ«éœ²äº¤æ˜“',
    'å…³è¿äº¤æ˜“', 'é—œé€£äº¤æ˜“',
    'éå¸¸é‡å¤§å‡ºå”®', 'éå¸¸é‡å¤§æ”¶è´­',
]


class DocumentFilter:
    """æ–‡æ¡£è¿‡æ»¤å™¨"""
    
    def __init__(self, pdf_path: str):
        self.pdf_path = Path(pdf_path)
        self.filename = self.pdf_path.stem
    
    def should_process(self) -> tuple[bool, str]:
        """
        åˆ¤æ–­æ–‡æ¡£æ˜¯å¦åº”è¯¥å¤„ç†
        
        Returns:
            (should_process, reason) - (æ˜¯å¦å¤„ç†, åŸå› è¯´æ˜)
        """
        # 1. ç™½åå•æ£€æŸ¥ï¼ˆä¼˜å…ˆï¼‰
        for keyword in PROCESS_KEYWORDS:
            if keyword in self.filename:
                return (True, f"ç™½åå•åŒ¹é…: {keyword}")
        
        # 2. é»‘åå•å…³é”®è¯æ£€æŸ¥
        for keyword in SKIP_KEYWORDS:
            if keyword in self.filename:
                return (False, f"é»‘åå•å…³é”®è¯: {keyword}")
        
        # 3. é»‘åå•æ¨¡å¼æ£€æŸ¥
        for pattern in SKIP_PATTERNS:
            if re.search(pattern, self.filename):
                return (False, f"é»‘åå•æ¨¡å¼åŒ¹é…: {pattern}")
        
        # 4. é»˜è®¤ï¼šå¤„ç†
        return (True, "æœªåŒ¹é…è·³è¿‡è§„åˆ™ï¼Œé»˜è®¤å¤„ç†")
    
    def print_decision(self):
        """æ‰“å°è¿‡æ»¤å†³ç­–"""
        should_process, reason = self.should_process()
        
        print("=" * 80)
        print("ğŸ“„ æ–‡æ¡£è¿‡æ»¤æ£€æŸ¥")
        print("=" * 80)
        print(f"æ–‡ä»¶: {self.filename}")
        print(f"è·¯å¾„: {self.pdf_path}")
        print("-" * 80)
        print(f"å†³ç­–: {'âœ… åº”è¯¥å¤„ç†' if should_process else 'â­ï¸  è·³è¿‡å¤„ç†'}")
        print(f"åŸå› : {reason}")
        print("=" * 80)
        
        return should_process


def main():
    if len(sys.argv) < 2:
        print("ç”¨æ³•: python document_filter.py <pdf_path>")
        print("è¿”å›ç : 0=åº”è¯¥å¤„ç†, 1=åº”è¯¥è·³è¿‡")
        sys.exit(2)
    
    pdf_path = sys.argv[1]
    
    if not Path(pdf_path).exists():
        print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {pdf_path}")
        sys.exit(2)
    
    filter = DocumentFilter(pdf_path)
    should_process = filter.print_decision()
    
    # è¿”å›ç ï¼š0=åº”è¯¥å¤„ç†ï¼Œ1=åº”è¯¥è·³è¿‡
    sys.exit(0 if should_process else 1)


if __name__ == '__main__':
    main()

